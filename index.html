<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rock-Paper-Scissors (Two-Hand Variant + Russian Roulette)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* 
      Squid Game color palette:
      #ed1b76 (237,27,118)
      #f44786 (244,71,134)
      #ffffff (255,255,255)
      #249f9c (36,159,156)
      #037a76 (3,122,118)
    */

    /* Reset + Basic Layout */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: Arial, sans-serif;
      background: #037a76; /* Deep teal background */
      color: #ffffff;      /* White text for contrast */
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 0.5em; /* Reduced padding for mobile */
      font-size: 0.9em; /* General font size reduction */
    }

    /*************************************************************
     * START MENU
     *************************************************************/
    #start-menu {
      text-align: center;
      width: 100%;
      max-width: 500px; /* Suitable for larger screens */
      margin: auto;
      background: #ed1b76; /* Bright pink background */
      padding: 1em; /* Adequate padding */
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      position: relative;
    }
    #start-menu h1 {
      margin-bottom: 0.4em;
      font-size: 1.4em; /* Reduced for smaller font */
      color: #ffffff;
    }
    #start-menu p {
      margin: 0.8em 0;
      line-height: 1.2em; /* Slightly reduced line height */
      color: #ffffff;
      font-size: 0.9em; /* Reduced for smaller font */
    }
    #start-menu label {
      font-weight: bold;
      color: #ffffff;
      font-size: 0.9em; /* Reduced for smaller font */
    }
    #start-menu select,
    #start-menu input[type="range"] {
      margin: 0.4em 0;
      padding: 0.4em; /* Reduced padding */
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.9em; /* Reduced for smaller font */
      width: 100%;
      max-width: 150px; /* Increased max-width to accommodate longer text */
      display: block;
      margin-bottom: 1em;
      text-align: center;
    }

    /* Sound Toggle Button Styling */
    #sound-btn {
      background: #f44786; /* Lighter pink button */
      color: #ffffff;
      border: none;
      border-radius: 4px;
      font-size: 0.9em; /* Reduced for smaller font */
      padding: 0.5em 0.8em; /* Reduced padding */
      cursor: pointer;
      margin-bottom: 1em;
      transition: background 0.3s;
      width: 100%;
      max-width: 200px; /* Increased max-width for better fit on mobile */
    }
    #sound-btn:hover {
      background: #249f9c; /* Teal hover */
    }

    /* Compact Slider and Mode Selection Container */
    .settings-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-around;
      gap: 0.8em; /* Reduced gap for better fit */
      flex-wrap: wrap;
      margin-bottom: 1em;
    }
    .setting-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.4em; /* Reduced gap */
      width: 100%; /* Full width on smaller screens */
      max-width: 150px; /* Increased max-width to accommodate larger content */
    }
    .setting-item label {
      margin-bottom: 0.4em;
    }
    .slider-container {
      display: flex;
      align-items: center;
      gap: 0.4em; /* Reduced gap */
      width: 100%;
    }
    .slider-container input[type="range"] {
      width: 100%;
      max-width: 200px; /* Increased max-width to accommodate longer text */
    }
    .slider-container span {
      width: 25px; /* Reduced width */
      text-align: center;
      font-weight: bold;
      font-size: 0.9em; /* Reduced for smaller font */
    }

    #start-btn {
      background: #f44786; /* Lighter pink button */
      color: #ffffff;
      border: none;
      border-radius: 4px;
      font-size: 1em; /* Slight reduction */
      padding: 0.5em 1em; /* Reduced padding */
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
      max-width: 200px; /* Increased max-width for better fit on mobile */
    }
    #start-btn:hover {
      background: #249f9c; /* Teal hover */
    }

    /*************************************************************
     * GAME CONTAINER
     *************************************************************/
    #game-container {
      width: 100%;
      max-width: 600px; /* Increased for better layout on larger screens */
      margin: 1.5em auto;
      background: #ed1b76; /* Pink background for game area */
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      padding: 1em; /* Adjusted padding */
      display: none; /* Hidden until game starts */
      position: relative;
    }

    /*************************************************************
     * AI SECTION (top)
     *************************************************************/
    #ai-section {
      text-align: center;
      margin-bottom: 1em;
    }
    #ai-section h2 {
      margin-bottom: 0.5em;
      font-size: 1em; /* Reduced for smaller font */
      color: #ffffff;
    }
    #ai-choices {
      display: flex;
      justify-content: space-around;
      align-items: flex-start;
      margin-bottom: 1em;
      flex-wrap: wrap; /* Allow wrapping on small screens */
      gap: 0.8em; /* Reduced gap for better spacing */
    }
    .ai-choice-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.4em; /* Reduced gap */
      width: 45%; /* Adjust width for better fit on mobile */
      max-width: 150px;
    }
    .ai-choice-btn {
      background: #f44786; /* Default AI button color */
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 0.9em; /* Reduced for smaller font */
      padding: 0.4em; /* Reduced padding */
      min-width: 50px; /* Reduced min-width */
      cursor: default;
      pointer-events: none; /* Not clickable by user */
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s, color 0.3s, border 0.3s;
      width: 100%; /* Full width within column */
      max-width: 80px; /* Reduced max-width */
    }
    .ai-choice-btn img {
      width: 25px; /* Reduced image size for better visibility */
      height: 25px;
    }
    .ai-choice-btn.selected {
      background: #ffffff; /* White highlight */
      color: #ed1b76;
      border: 2px solid #f44786;
    }

    /*************************************************************
     * SCOREBOARD (center)
     *************************************************************/
    #scoreboard {
      text-align: center;
      margin: 0.5em auto 0.5em;
      font-size: 0.8em; /* Further reduced font size for mobile */
      display: flex;
      justify-content: center;
      gap: 0.8em; /* Reduced gap for better fit */
      flex-wrap: wrap;
    }
    #scoreboard div {
      background: #249f9c; /* Teal scoreboard background */
      color: #ffffff;
      padding: 0.3em 0.6em; /* Reduced padding for smaller size */
      border-radius: 4px;
      font-size: 0.8em; /* Further reduced font size */
      width: 45%;
      min-width: 80px; /* Reduced min-width for better fit */
    }

    /* TIMER & STATUS */
    #timer-display {
      text-align: center;
      margin-bottom: 1em;
      font-size: 0.7em; /* Further reduced font size */
      background: #249f9c;
      color: #ffffff;
      padding: 0.3em; /* Reduced padding */
      border-radius: 4px;
      max-width: 200px; /* Reduced max-width */
      margin: 0.5em auto; /* Center it */
    }
    #status-message {
      text-align: center;
      font-weight: bold;
      margin-bottom: 1em;
      min-height: 2em;
      color: #ffffff;
      font-size: 0.8em; /* Reduced font size */
    }

    /*************************************************************
     * RESULT SECTION
     *************************************************************/
    #result-section {
      text-align: center;
      margin-top: 1em;
      display: none; /* Shown after reveal */
    }
    #result-message {
      font-weight: bold;
      margin-bottom: 0.6em;
      color: #ffffff; 
      font-size: 0.9em; /* Reduced for smaller font */
    }
    /* Hide the Next Round button by default */
    #next-round-btn {
      display: none;
      background: #f44786;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 0.9em; /* Reduced for smaller font */
      padding: 0.4em 0.8em; /* Reduced padding */
      cursor: pointer;
      transition: background 0.3s;
      max-width: 150px; /* Reduced max-width */
      margin: 0.5em auto 0;
      width: 100%;
    }
    #next-round-btn:hover {
      background: #249f9c;
    }

    /*************************************************************
     * RUSSIAN ROULETTE VISUALS
     *************************************************************/
    #roulette-visual {
      text-align: center;
      display: none;
      margin: 1em auto;
      font-size: 0.8em; /* Reduced font size */
      border: 2px dashed #f44786;
      padding: 0.5em; /* Reduced padding */
      border-radius: 8px;
      background: #ffffff;
      width: 100%;
      max-width: 300px; /* Reduced max-width for smaller interface */
      color: #ed1b76;
    }
    #roulette-visual h3 {
      margin-bottom: 0.5em;
      color: #ed1b76;
      font-size: 0.9em; /* Reduced font size */
    }
    #roulette-spin {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8em; /* Reduced font size */
    }
    #roulette-outcome {
      margin-top: 0.5em;
      font-weight: bold;
      font-size: 0.9em; /* Reduced font size */
    }
    /* Simple spin animation for "spinning" text */
    .spin-animation {
      display: inline-block;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

    /* *************************************************************
     * PLAYER SECTION (bottom)
     *************************************************************/
    #user-section {
      text-align: center;
      margin-top: 1em;
    }
    #user-section h2 {
      margin-bottom: 0.5em;
      font-size: 1em; /* Reduced for smaller font */
      color: #ffffff;
    }

    /* Two vertical stacks at the bottom for player's left & right */
    #user-choices {
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      margin-bottom: 1em;
      gap: 0.8em; /* Reduced gap */
      flex-wrap: wrap; /* Allow wrapping on small screens */
    }
    .user-choice-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.4em; /* Reduced gap */
      width: 45%;
      max-width: 150px;
    }
    .choice-btn {
      background: #f44786;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 0.9em; /* Reduced for smaller font */
      padding: 0.4em; /* Reduced padding */
      min-width: 50px; /* Reduced min-width */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s, color 0.3s, border 0.3s;
      width: 100%; /* Full width within column */
      max-width: 80px; /* Reduced max-width */
    }
    .choice-btn:hover {
      background: #249f9c;
    }
    .choice-btn.selected {
      background: #ffffff; 
      color: #ed1b76;
      border: 2px solid #f44786;
    }
    .choice-btn img {
      width: 25px; /* Reduced image size for better visibility */
      height: 25px;
    }

    /*************************************************************
     * WINNER HIGHLIGHTING
     *************************************************************/
    .winner {
      border: 2px solid #ffff00; /* Reduced border size */
      box-shadow: 0 0 5px #ffff00; /* Reduced shadow size */
    }

    /*************************************************************
     * MEDIA QUERIES FOR MOBILE OPTIMIZATION
     *************************************************************/
    @media (max-width: 768px) {
      /* Tablet devices */
      #start-menu, #game-container {
        max-width: 90%;
      }
      #ai-choice-btn img, .choice-btn img {
        width: 25px; /* Further reduced image size */
        height: 25px;
      }
      #scoreboard div {
        width: 45%;
      }
      #roulette-visual {
        max-width: 250px; /* Further reduced max-width */
      }
      #timer-display {
        max-width: 180px; /* Adjusted for smaller interface */
      }
    }

    @media (max-width: 480px) {
      /* Mobile devices */
      /* Further reduce font sizes */
      #start-menu h1 {
        font-size: 1.2em; /* Further reduced for smaller screens */
      }
      #start-menu p, #start-menu label {
        font-size: 0.85em; /* Further reduced for smaller screens */
      }
      #sound-btn, #start-btn, #next-round-btn {
        font-size: 0.9em; /* Reduced for smaller screens */
        padding: 0.5em 0.8em; /* Reduced padding */
      }
      /* Arrange AI and User choice columns side by side */
      .ai-choice-column,
      .user-choice-column {
        width: 45%; /* Adjusted from 100% to 45% for side-by-side layout */
        max-width: 150px; /* Ensures buttons fit within the screen */
      }
      /* Ensure buttons and images are appropriately sized */
      .ai-choice-btn,
      .choice-btn {
        max-width: 80px; /* Further reduced max-width for better touch targets */
        padding: 0.5em; /* Reduced padding */
      }
      .ai-choice-btn img,
      .choice-btn img {
        width: 20px; /* Further reduced image size for better visibility */
        height: 20px;
      }
      /* Adjust scoreboard layout */
      #scoreboard {
        flex-direction: row;
        justify-content: center;
        gap: 0.8em; /* Reduced gap for better fit */
      }
      #scoreboard div {
        width: 45%;
        max-width: 100px; /* Further reduced max-width for better fit on mobile */
        font-size: 0.8em; /* Further reduced font size */
        padding: 0.3em 0.5em; /* Reduced padding */
      }
      /* Move timer below scoreboard */
      #timer-display {
        margin-top: 0.5em;
        font-size: 0.7em; /* Further reduced font size */
        max-width: 150px; /* Ensure it doesn't take too much width */
        padding: 0.2em; /* Further reduced padding */
      }
      /* Ensure sliders fit within the screen */
      .slider-container {
        flex-direction: column;
        align-items: stretch;
      }
      .slider-container input[type="range"] {
        width: 100%;
        max-width: 200px; /* Adjusted to match larger size */
      }
      /* Adjust roulette visual */
      #roulette-visual {
        padding: 0.5em; /* Further reduced padding */
        max-width: 250px; /* Further reduced max-width */
      }
      /* Adjust status message font size */
      #status-message,
      #result-message,
      #roulette-outcome {
        font-size: 0.8em; /* Further reduced font size */
      }
      /* Adjust buttons to be full width */
      #sound-btn,
      #start-btn,
      #next-round-btn {
        max-width: none;
        width: 100%;
      }
      /* Increase touch areas for better usability */
      .choice-btn, .ai-choice-btn {
        padding: 0.5em; /* Reduced padding */
      }
      /* Arrange AI and User choices side by side */
      #ai-choices, #user-choices {
        flex-direction: row;
        justify-content: space-between;
      }
      /* Further reduce roulette visual font size */
      #roulette-visual h3 {
        font-size: 0.8em; /* Further reduced font size */
      }
    }

    /* Additional media queries for very small devices */
    @media (max-width: 360px) {
      #start-menu h1 {
        font-size: 1em; /* Further reduced */
      }
      #ai-choice-btn img, .choice-btn img {
        width: 18px; /* Further reduced image size */
        height: 18px;
      }
      #scoreboard div {
        width: 100%;
        max-width: 100px; /* Adjusted */
      }
      .choice-btn, .ai-choice-btn {
        max-width: 70px; /* Further reduced */
      }
      /* Further reduce timer display on very small screens */
      #timer-display {
        font-size: 0.6em; /* Further reduced font size */
        padding: 0.1em; /* Further reduced padding */
        max-width: 100px; /* Further reduced max-width */
      }
      /* Further reduce Russian Roulette font sizes */
      #roulette-visual h3 {
        font-size: 0.7em; /* Further reduced */
      }
      #roulette-spin {
        font-size: 0.7em; /* Further reduced */
      }
      #roulette-outcome {
        font-size: 0.8em; /* Further reduced */
      }
    }

  </style>
</head>
<body>

  <!-- START MENU -->
  <div id="start-menu">
    <h1>Rock-Paper-Scissors: Two-Hand</h1>

    <!-- Sound Toggle Button -->
    <button id="sound-btn" data-sound="off">Sound: OFF</button>

    <p><strong>New Rule:</strong><br>
      If you fail to pick a hand within 5 seconds, AI wins that round.
    </p>

    <!-- Compact Settings Container -->
    <div class="settings-container">
      <!-- Russian Roulette Mode Selection -->
      <div class="setting-item">
        <label for="mode-select">Roulette Mode:</label>
        <select id="mode-select">
          <option value="reset">Reset each round</option>
          <option value="no-reset">No reset</option>
        </select>
      </div>

      <!-- Number of Bullets Slider -->
      <div class="setting-item">
        <label for="num-bullets">Bullets:</label>
        <div class="slider-container">
          <input type="range" id="num-bullets" value="1" min="1" max="6" step="1">
          <span id="bullet-count">1</span>
        </div>
      </div>
    </div>

    <button id="start-btn">Start Game</button>
  </div>

  <!-- GAME CONTAINER -->
  <div id="game-container">

    <!-- AI SECTION -->
    <div id="ai-section">
      <h2>AI's Stage</h2>
      <div id="ai-choices">
        <!-- Left column -->
        <div class="ai-choice-column">
          <button class="ai-choice-btn" data-hand="Rock" data-side="left">
            <img src="./assets/icons/rock.png" alt="Rock">
          </button>
          <button class="ai-choice-btn" data-hand="Paper" data-side="left">
            <img src="./assets/icons/paper.png" alt="Paper">
          </button>
          <button class="ai-choice-btn" data-hand="Scissors" data-side="left">
            <img src="./assets/icons/scissors.png" alt="Scissors">
          </button>
        </div>
        <!-- Right column -->
        <div class="ai-choice-column">
          <button class="ai-choice-btn" data-hand="Rock" data-side="right">
            <img src="./assets/icons/rock.png" alt="Rock">
          </button>
          <button class="ai-choice-btn" data-hand="Paper" data-side="right">
            <img src="./assets/icons/paper.png" alt="Paper">
          </button>
          <button class="ai-choice-btn" data-hand="Scissors" data-side="right">
            <img src="./assets/icons/scissors.png" alt="Scissors">
          </button>
        </div>
      </div>
    </div>

    <!-- SCOREBOARD -->
    <div id="scoreboard">
      <div>Player: <span id="player-score">0</span></div>
      <div>AI: <span id="ai-score">0</span></div>
    </div>

    <!-- TIMER & STATUS -->
    <div id="timer-display">Timer: 5s</div>
    <div id="status-message"></div>

    <!-- RESULT SECTION -->
    <div id="result-section">
      <p id="result-message"></p>
      <button id="next-round-btn">Next Round</button>
    </div>

    <!-- RUSSIAN ROULETTE VISUAL -->
    <div id="roulette-visual">
      <h3>Russian Roulette!</h3>
      <p id="roulette-spin">Spinning: <span class="spin-animation">🔄</span></p>
      <p id="roulette-outcome"></p>
    </div>

    <!-- PLAYER SECTION -->
    <div id="user-section">
      <h2>Player's Stage</h2>
      <div id="user-choices">
        <div class="user-choice-column" id="user-left-column"></div>
        <div class="user-choice-column" id="user-right-column"></div>
      </div>
    </div>

  </div>

  <!-- Audio Elements -->
  <audio id="bg-music" src="./assets/sounds/scary.mp3" preload="auto" loop></audio>
  <audio id="intro-music" src="./assets/sounds/intro.mp3" preload="auto"></audio>
  <audio id="reload-music" src="./assets/sounds/reload.mp3" preload="auto"></audio>
  <audio id="fire-sound" src="./assets/sounds/fire.wav" preload="auto"></audio>
  <audio id="empty-sound" src="./assets/sounds/empty.wav" preload="auto"></audio>
  <audio id="green-sound" src="./assets/sounds/green.mp3" preload="auto"></audio> <!-- New Audio Element -->

  <script>
    /****************************************************
     * SOUND LOGIC
     ****************************************************/
    // Background music for the Start Menu (looped)
    const backgroundMusic = document.getElementById('bg-music');

    // Intro music that plays each round
    const introMusic = document.getElementById('intro-music');

    // Additional Audio Elements
    const reloadMusic = document.getElementById('reload-music');
    const fireSound = document.getElementById('fire-sound');
    const emptySound = document.getElementById('empty-sound');
    const greenSound = document.getElementById('green-sound'); // New Audio Element

    // Track whether sound is ON or OFF
    let isSoundOn = false;

    // Grab the toggle button and slider
    const soundBtn = document.getElementById('sound-btn');
    const numBulletsSlider = document.getElementById('num-bullets');
    const bulletCountDisplay = document.getElementById('bullet-count');

    // Update bullet count display when slider changes
    numBulletsSlider.addEventListener('input', () => {
      bulletCountDisplay.textContent = numBulletsSlider.value;
    });

    // Sound Toggle Button Event Listener
    soundBtn.addEventListener('click', () => {
      isSoundOn = !isSoundOn;
      if (isSoundOn) {
        soundBtn.textContent = "Sound: ON";
        soundBtn.setAttribute('data-sound', 'on');
        // Attempt to play background music
        backgroundMusic.currentTime = 0;
        const playPromise = backgroundMusic.play();
        if (playPromise !== undefined) {
          playPromise.then(() => {
            // Automatic playback started!
          }).catch(error => {
            console.warn("Background music playback failed:", error);
          });
        }
      } else {
        soundBtn.textContent = "Sound: OFF";
        soundBtn.setAttribute('data-sound', 'off');
        // Stop all sounds
        backgroundMusic.pause();
        backgroundMusic.currentTime = 0;
        introMusic.pause();
        introMusic.currentTime = 0;
        reloadMusic.pause();
        reloadMusic.currentTime = 0;
        fireSound.pause();
        fireSound.currentTime = 0;
        emptySound.pause();
        emptySound.currentTime = 0;
        greenSound.pause(); // Stop greenSound if playing
        greenSound.currentTime = 0;
      }
    });

    /****************************************************
     * STATE / ELEMENTS
     ****************************************************/
    const startMenu       = document.getElementById('start-menu');
    const startBtn        = document.getElementById('start-btn');
    const gameContainer   = document.getElementById('game-container');
    const modeSelect      = document.getElementById('mode-select');
    const numBulletsInput = document.getElementById('num-bullets'); // Now a slider

    const aiChoiceButtons = document.querySelectorAll('.ai-choice-btn');

    const RPS = [
      { name: 'Rock',     img: './assets/icons/rock.png' },
      { name: 'Paper',    img: './assets/icons/paper.png' },
      { name: 'Scissors', img: './assets/icons/scissors.png' },
    ];

    const userLeftCol   = document.getElementById('user-left-column');
    const userRightCol  = document.getElementById('user-right-column');

    // Score & Timer
    const playerScoreEl = document.getElementById('player-score');
    const aiScoreEl     = document.getElementById('ai-score');
    let playerScore = 0;
    let aiScore = 0;

    const timerDisplay    = document.getElementById('timer-display');
    const statusMessage   = document.getElementById('status-message');
    const resultSection   = document.getElementById('result-section');
    const resultMessage   = document.getElementById('result-message');
    const nextRoundBtn    = document.getElementById('next-round-btn');

    // Russian Roulette elements
    const rouletteVisual  = document.getElementById('roulette-visual');
    const rouletteSpin    = document.getElementById('roulette-spin');
    const rouletteOutcome = document.getElementById('roulette-outcome');

    // Selections
    let playerLeftHand  = null;
    let playerRightHand = null;
    let aiLeftHand      = null;
    let aiRightHand     = null;

    // Track the side of the player's final choice
    let playerFinalChoiceSide = null;

    // Timers & phases
    let intervalId = null;
    let timeLeft   = 5;
    // phase = 1 => picking L & R, 2 => picking final
    let phase      = 1;

    // Roulette configuration
    let rouletteMode     = 'reset'; // or 'no-reset'
    let bulletsInChamber = 1;
    let chamberPositions = [false, false, false, false, false, false];
    let currentChamberIndex = 0;
    let gameOver = false;

    /****************************************************
     * START BUTTON
     ****************************************************/
    startBtn.addEventListener('click', () => {
      // Stop the menu background music
      if (isSoundOn) {
        backgroundMusic.pause();
        backgroundMusic.currentTime = 0;
      }

      // Hide menu
      startMenu.style.display = 'none';
      // Show game
      gameContainer.style.display = 'block';

      // Set user settings
      rouletteMode = modeSelect.value;
      bulletsInChamber = parseInt(numBulletsSlider.value, 10) || 1;
      if (bulletsInChamber < 1) bulletsInChamber = 1;
      if (bulletsInChamber > 6) bulletsInChamber = 6;

      // Reset scores and game state
      playerScore = 0;
      aiScore = 0;
      playerScoreEl.textContent = playerScore;
      aiScoreEl.textContent = aiScore;
      gameOver = false;

      // Setup chamber positions based on mode
      if (rouletteMode === 'no-reset') {
        setupNoResetChamber(bulletsInChamber);
      } else {
        chamberPositions = [false, false, false, false, false, false];
        currentChamberIndex = 0;
      }

      // Start the first round
      startRound();
    });

    /****************************************************
     * NEXT ROUND BUTTON - Handle Both 'Next Round' and 'Restart Game'
     ****************************************************/
    nextRoundBtn.addEventListener('click', () => {
      if (gameOver) {
        restartGame(); // Restart the game if game over
      } else {
        startRound(); // Start the next round
      }
    });

    /****************************************************
     * ROUND LOGIC
     ****************************************************/
    function startRound() {
      // Reset 'Next Round' button text to 'Next Round'
      nextRoundBtn.textContent = 'Next Round';
      // Hide the Next Round button initially
      nextRoundBtn.style.display = 'none';

      // Clear any existing winner highlights
      const allWinnerButtons = document.querySelectorAll('.winner');
      allWinnerButtons.forEach(btn => btn.classList.remove('winner'));

      // Reset the final choice side
      playerFinalChoiceSide = null;

      // Stop any leftover intro music
      introMusic.pause();
      introMusic.currentTime = 0;

      // If sound is ON, play intro for this round at normal speed
      if (isSoundOn) {
        introMusic.playbackRate = 1.0; // Set playback speed to normal
        const playPromise = introMusic.play();
        if (playPromise !== undefined) {
          playPromise.then(() => {
            // Intro music playing
          }).catch(error => {
            console.warn("Intro music playback failed:", error);
          });
        }
      }

      rouletteVisual.style.display = 'none';
      rouletteOutcome.textContent = '';
      rouletteSpin.style.display = 'inline-block';

      phase = 1;
      timeLeft = 5;
      timerDisplay.textContent = `Timer: ${timeLeft}s`;
      statusMessage.textContent = 'Pick your hands (5s)!';
      resultSection.style.display = 'none';
      resultMessage.textContent = '';

      // Reset picks
      playerLeftHand  = null;
      playerRightHand = null;
      aiLeftHand      = null;
      aiRightHand     = null;
      aiChoiceButtons.forEach(b => b.classList.remove('selected'));

      // Build user columns
      buildUserColumns();

      // Start Phase 1 timer
      if (intervalId) clearInterval(intervalId);
      intervalId = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = `Timer: ${timeLeft}s`;

        if (timeLeft <= 0) {
          clearInterval(intervalId);
          // If user hasn't chosen BOTH left & right, immediate AI win
          if (!playerLeftHand || !playerRightHand) {
            concludeRoundWithAiWin('Time up! AI wins.');
          } else {
            highlightAIHands();
            moveToPhase2();
          }
        }
      }, 1000);
    }

    function moveToPhase2() {
      phase = 2;
      timeLeft = 5;
      timerDisplay.textContent = `Timer: ${timeLeft}s`;
      statusMessage.textContent = 'Pick one final hand (5s)!';

      if (intervalId) clearInterval(intervalId);
      intervalId = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = `Timer: ${timeLeft}s`;

        if (timeLeft <= 0) {
          clearInterval(intervalId);
          concludeRoundWithAiWin('Time up! AI wins.');
        }
      }, 1000);
    }

    /****************************************************
     * IF USER FAILS => AI WINS
     ****************************************************/
    function concludeRoundWithAiWin(reason) {
      if (gameOver) return;
      phase = 0;
      statusMessage.textContent = 'Round Over!';

      // Hide the Next Round button initially
      nextRoundBtn.style.display = 'none';

      // Show the result section without the button
      resultSection.style.display = 'block';
      resultMessage.textContent = `${reason}`;
      aiScore++;
      aiScoreEl.textContent = aiScore;

      // Highlight AI's final hand
      highlightAIHandsFinal();

      performRussianRoulette('user');
    }

    /****************************************************
     * WHEN USER PICKS FINAL
     ****************************************************/
    function concludeRound(playerFinalHand, playerFinalChoiceSide) {
      if (intervalId) clearInterval(intervalId);
      phase = 0;

      // Stop introMusic when user makes final choice
      introMusic.pause();
      introMusic.currentTime = 0;

      // AI picks final after seeing user’s final
      const aiFinal = chooseAiBestResponse(aiLeftHand, aiRightHand, playerFinalHand);

      if (aiFinal === aiLeftHand) {
        unhighlightAIHand('right');
      } else {
        unhighlightAIHand('left');
      }

      const winner = getWinner(playerFinalHand, aiFinal);
      
      // Hide the Next Round button initially
      nextRoundBtn.style.display = 'none';
      
      // Show the result section without the button
      resultSection.style.display = 'block';

      if (winner === 'Player') {
        playerScore++;
        playerScoreEl.textContent = playerScore;
        resultMessage.textContent = `You win!`;
        // Highlight player's final hand
        const playerFinalBtn = findUserButton(playerFinalHand, playerFinalChoiceSide);
        playerFinalBtn?.classList.add('winner');
        // Russian Roulette for AI
        performRussianRoulette('ai');
      }
      else if (winner === 'AI') {
        aiScore++;
        aiScoreEl.textContent = aiScore;
        resultMessage.textContent = `AI wins!`;
        // Highlight AI's final hand
        const aiFinalSide = (aiFinal === aiLeftHand) ? 'left' : 'right';
        const aiFinalBtn = findAIButton(aiFinal, aiFinalSide);
        aiFinalBtn?.classList.add('winner');
        // Russian Roulette for Player
        performRussianRoulette('user');
      }
      else {
        // DRAW => Highlight both hands
        resultMessage.textContent = `It's a draw!`;
        const playerFinalBtn = findUserButton(playerFinalHand, playerFinalChoiceSide);
        const aiFinalSide = (aiFinal === aiLeftHand) ? 'left' : 'right';
        const aiFinalBtn = findAIButton(aiFinal, aiFinalSide);
        playerFinalBtn?.classList.add('winner');
        aiFinalBtn?.classList.add('winner');
        // Play green.mp3 and no Russian Roulette
        playGreenSound();
        
        // Show the Next Round button immediately for a draw
        nextRoundBtn.style.display = 'block';
      }

      statusMessage.textContent = 'Round Over!';
    }

    /****************************************************
     * RUSSIAN ROULETTE
     ****************************************************/
    function performRussianRoulette(target) {
      // target = 'user' or 'ai'
      if (gameOver) return;

      rouletteVisual.style.display = 'block';
      rouletteSpin.style.display = 'inline-block';
      rouletteOutcome.textContent = '';

      // Stop introMusic if still playing
      introMusic.pause();
      introMusic.currentTime = 0;

      // Play reload.mp3 first
      if (isSoundOn) {
        reloadMusic.currentTime = 0;
        const playPromise = reloadMusic.play();
        if (playPromise !== undefined) {
          playPromise.then(() => {
            // After reload.mp3 finishes, determine outcome
            determineRouletteOutcome(target);
          }).catch(error => {
            console.warn("Reload sound playback failed:", error);
            // Proceed to outcome determination even if sound is blocked
            determineRouletteOutcome(target);
          });
        }
      } else {
        // If sound is off, proceed immediately
        determineRouletteOutcome(target);
      }
    }

    function determineRouletteOutcome(target) {
      // Simulate a slight delay to sync with reload.mp3 if needed
      setTimeout(() => {
        // Determine if bullet fires
        let bulletFires = false;
        if (rouletteMode === 'reset') {
          // For reset each round, chance = bullets/6
          const rand = Math.floor(Math.random() * 6) + 1;
          bulletFires = (rand <= bulletsInChamber);
        } else {
          // No-reset: check currentChamberIndex
          bulletFires = chamberPositions[currentChamberIndex];
          currentChamberIndex = (currentChamberIndex + 1) % 6;
        }

        // Play outcome sound
        if (isSoundOn) {
          if (bulletFires) {
            fireSound.currentTime = 0;
            const playPromise = fireSound.play();
            if (playPromise !== undefined) {
              playPromise.then(() => {
                // After fire.wav finishes, update the UI
                updateRouletteOutcome(target, true);
              }).catch(error => {
                console.warn("Fire sound playback failed:", error);
                // Update UI even if sound is blocked
                updateRouletteOutcome(target, true);
              });
            }
          } else {
            emptySound.currentTime = 0;
            const playPromise = emptySound.play();
            if (playPromise !== undefined) {
              playPromise.then(() => {
                // After empty.wav finishes, update the UI
                updateRouletteOutcome(target, false);
              }).catch(error => {
                console.warn("Empty sound playback failed:", error);
                // Update UI even if sound is blocked
                updateRouletteOutcome(target, false);
              });
            }
          }
        } else {
          // If sound is off, proceed to update UI
          updateRouletteOutcome(target, bulletFires);
        }
      }, 600); // Adjusted delay for better synchronization
    }

    function updateRouletteOutcome(target, bulletFires) {
      rouletteSpin.style.display = 'none';

      if (bulletFires) {
        rouletteOutcome.textContent = `BANG! ${target.toUpperCase()} is shot.`;
        gameOver = true; // Set gameOver flag
        statusMessage.textContent = 'GAME OVER!';

        if (target === 'user') {
          resultMessage.textContent += ' YOU were shot. AI wins the match!';
        } else {
          resultMessage.textContent += ' AI was shot. YOU win the match!';
        }
      } else {
        rouletteOutcome.textContent = `CLICK! ${target.toUpperCase()} survives.`;
      }

      // Show the Next Round button after Russian Roulette is done
      nextRoundBtn.style.display = 'block';

      // Set 'nextRoundBtn' text based on 'gameOver'
      if (gameOver) {
        nextRoundBtn.textContent = 'Restart Game';
      } else {
        nextRoundBtn.textContent = 'Next Round';
      }
    }

    function setupNoResetChamber(bulletsCount) {
      chamberPositions = [false, false, false, false, false, false];
      currentChamberIndex = 0;
      let count = Math.min(bulletsCount, 6);
      while (count > 0) {
        const idx = Math.floor(Math.random() * 6);
        if (!chamberPositions[idx]) {
          chamberPositions[idx] = true;
          count--;
        }
      }
    }

    /****************************************************
     * BUILD USER CHOICES
     ****************************************************/
    function buildUserColumns() {
      userLeftCol.innerHTML = '';
      userRightCol.innerHTML = '';

      const leftShuffled  = shuffleArray([...RPS]);
      const rightShuffled = shuffleArray([...RPS]);

      leftShuffled.forEach(item => {
        const btn = document.createElement('button');
        btn.classList.add('choice-btn');
        btn.setAttribute('data-hand', item.name);
        btn.setAttribute('data-side', 'left');
        const img = document.createElement('img');
        img.src = item.img;
        img.alt = item.name;
        btn.appendChild(img);

        btn.addEventListener('click', onUserChoiceClick);
        userLeftCol.appendChild(btn);
      });

      rightShuffled.forEach(item => {
        const btn = document.createElement('button');
        btn.classList.add('choice-btn');
        btn.setAttribute('data-hand', item.name);
        btn.setAttribute('data-side', 'right');
        const img = document.createElement('img');
        img.src = item.img;
        img.alt = item.name;
        btn.appendChild(img);

        btn.addEventListener('click', onUserChoiceClick);
        userRightCol.appendChild(btn);
      });
    }

    function onUserChoiceClick(e) {
      if (phase !== 1 && phase !== 2) return;
      const side = e.currentTarget.getAttribute('data-side');
      const hand = e.currentTarget.getAttribute('data-hand');

      if (phase === 1) {
          // Toggle left/right selection
          if (side === 'left') {
              playerLeftHand = (playerLeftHand === hand) ? null : hand;
          } else {
              playerRightHand = (playerRightHand === hand) ? null : hand;
          }
          updateUserSelectedStates();

          // If both chosen, proceed
          if (playerLeftHand && playerRightHand) {
              clearInterval(intervalId);
              highlightAIHands();
              moveToPhase2();
          }
      }
      else if (phase === 2) {
          if (!playerLeftHand || !playerRightHand) return;
          const finalChoice = (side === 'left') ? playerLeftHand : playerRightHand;
          playerFinalChoiceSide = side;

          if (playerLeftHand === playerRightHand) {
              // Both hands are the same; no need to unhighlight any hand
              // Highlight the selected hand to reflect the user's choice
              highlightSelectedUserHand(side);
          } else {
              // Hands are different; proceed as usual
              if (finalChoice === playerLeftHand) {
                  unhighlightUserHand('right');
              } else {
                  unhighlightUserHand('left');
              }
          }
          concludeRound(finalChoice, side);
      }
    }

    function highlightSelectedUserHand(side) {
      // Remove 'selected' class from all user choice buttons
      const allUserButtons = document.querySelectorAll('#user-choices .choice-btn');
      allUserButtons.forEach(btn => btn.classList.remove('selected'));

      // Add 'selected' class to the chosen side's button
      const chosenHand = (side === 'left') ? playerLeftHand : playerRightHand;
      const selectedButton = document.querySelector(`#user-${side}-column .choice-btn[data-hand="${chosenHand}"]`);
      if (selectedButton) {
          selectedButton.classList.add('selected');
      }
    }

    /****************************************************
     * AI CHOICES
     ****************************************************/
    function highlightAIHands() {
      let firstPick = randomGestureName();
      let secondPick = randomGestureName();
      aiLeftHand = firstPick;
      aiRightHand = secondPick;

      aiChoiceButtons.forEach(b => b.classList.remove('selected'));

      findAIButton(firstPick, 'left')?.classList.add('selected');
      findAIButton(secondPick, 'right')?.classList.add('selected');
    }

    function highlightAIHandsFinal() {
      // This function is used when AI wins automatically due to user timeout
      // AI selects its hands and highlights the final chosen one
      let firstPick = randomGestureName();
      let secondPick = randomGestureName();
     
      aiLeftHand = firstPick;
      aiRightHand = secondPick;

      aiChoiceButtons.forEach(b => b.classList.remove('selected'));

      findAIButton(firstPick, 'left')?.classList.add('selected');
      findAIButton(secondPick, 'right')?.classList.add('selected');
    }

    function chooseAiBestResponse(hand1, hand2, playerFinal) {
      // If both AI & user had 2 distinct hands, pick randomly if all 3 distinct combos
      if (hand1 !== hand2 && playerLeftHand !== playerRightHand) {
        const allHands = new Set([hand1, hand2, playerFinal]);
        if (allHands.size === 3) {
          // 50% probability
          return Math.random() < 0.5 ? hand1 : hand2;
        }
      }

      // Otherwise, pick based on best outcome
      const outcome1 = getWinner(playerFinal, hand1);
      const outcome2 = getWinner(playerFinal, hand2);

      // Priority: Win > Draw > Lose
      function rank(res) {
        if (res === 'AI')   return 3;
        if (res === 'Draw') return 2;
        return 1; // 'Player' means AI lost
      }
      const r1 = rank(outcome1);
      const r2 = rank(outcome2);

      if (r1 > r2) return hand1;
      if (r2 > r1) return hand2;
      return hand1; // Tie => pick first
    }

    /****************************************************
     * VISUAL HIGHLIGHTING
     ****************************************************/
    function updateUserSelectedStates() {
      const allBtns = document.querySelectorAll('#user-choices .choice-btn');
      allBtns.forEach(btn => {
        const side = btn.getAttribute('data-side');
        const hand = btn.getAttribute('data-hand');
        btn.classList.remove('selected');
        if (side === 'left' && hand === playerLeftHand) {
          btn.classList.add('selected');
        }
        if (side === 'right' && hand === playerRightHand) {
          btn.classList.add('selected');
        }
      });
    }

    function unhighlightUserHand(side) {
      const allBtns = document.querySelectorAll('#user-choices .choice-btn');
      allBtns.forEach(btn => {
        if (btn.getAttribute('data-side') === side) {
          btn.classList.remove('selected');
        }
      });
    }

    function unhighlightAIHand(side) {
      aiChoiceButtons.forEach(btn => {
        if (btn.getAttribute('data-side') === side) {
          btn.classList.remove('selected');
        }
      });
    }

    /****************************************************
     * PLAY GREEN SOUND FOR DRAW
     ****************************************************/
    function playGreenSound() {
      if (isSoundOn) {
        greenSound.currentTime = 0;
        const playPromise = greenSound.play();
        if (playPromise !== undefined) {
          playPromise.then(() => {
            // Green sound played
          }).catch(error => {
            console.warn("Green sound playback failed:", error);
          });
        }
      }
    }

    /****************************************************
     * HELPERS
     ****************************************************/
    function findAIButton(hand, side) {
      return document.querySelector(`.ai-choice-btn[data-hand="${hand}"][data-side="${side}"]`);
    }

    function findUserButton(hand, side) {
      return document.querySelector(`#user-${side}-column .choice-btn[data-hand="${hand}"]`);
    }

    // From user's perspective => getWinner(userGesture, aiGesture)
    function getWinner(user, ai) {
      if (user === ai) return 'Draw';
      if (
        (user === 'Rock' && ai === 'Scissors') ||
        (user === 'Paper' && ai === 'Rock') ||
        (user === 'Scissors' && ai === 'Paper')
      ) {
        return 'Player';
      }
      return 'AI';
    }

    function randomGestureName() {
      const list = ['Rock','Paper','Scissors'];
      return list[Math.floor(Math.random() * list.length)];
    }

    // Fisher-Yates shuffle
    function shuffleArray(arr) {
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    /****************************************************
     * RESTART GAME FUNCTION
     ****************************************************/
    function restartGame() {
      // Reset scores
      playerScore = 0;
      aiScore = 0;
      playerScoreEl.textContent = playerScore;
      aiScoreEl.textContent = aiScore;

      // Hide game container
      gameContainer.style.display = 'none';
      
      // Show start menu
      startMenu.style.display = 'block';
      
      // Reset gameOver flag
      gameOver = false;

      // Reset chamber positions if needed
      if (rouletteMode === 'no-reset') {
        setupNoResetChamber(bulletsInChamber);
      } else {
        chamberPositions = [false, false, false, false, false, false];
        currentChamberIndex = 0;
      }

      // Reset result section
      resultSection.style.display = 'none';
      resultMessage.textContent = '';
      statusMessage.textContent = '';
      timerDisplay.textContent = 'Timer: 5s';

      // Hide the Next Round button in case it's visible
      nextRoundBtn.style.display = 'none';
    }

  </script>
</body>
</html>
