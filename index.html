<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>● ■ ▲: The Rock Paper Scissors Roulette</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /*************************************************************
     * 1) ROCK-PAPER-SCISSORS ROULETTE GAME STYLES
     *************************************************************/
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      /* For RPS background */
      background: #037a76; /* Deep teal */
      overflow-x: hidden;
    }
    body {
      font-family: Arial, sans-serif;
      color: #ffffff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 0.5rem; 
      justify-content: flex-start;
    }

    /*************************************************************
     * START MENU
     *************************************************************/
    #start-menu {
      text-align: center;
      width: 100%;
      max-width: 450px;
      margin: 6rem auto;            
      background: #ed1b76;
      padding: 1rem;                
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
    }
    #start-menu h1 {
      margin-bottom: 1rem;        
      font-size: 1.2rem;           
      line-height: 1.4rem;
    }
    #start-menu p {
      margin: 1rem 0 2rem;        
      line-height: 1.4em;
      font-size: 0.9rem;
    }
    #start-menu label {
      font-size: 0.85rem;
      font-weight: normal;
      color: #ffffff;
    }
    #sound-btn {
      background: #f44786;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      font-size: 0.85rem;
      padding: 0.5rem 1rem;       
      cursor: pointer;
      margin: 1rem auto;          
      transition: background 0.3s;
      width: 100%;
      max-width: 150px;
    }
    .settings-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
      margin: 1rem auto;          
      width: 100%;
      max-width: 400px;
    }
    .setting-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      width: 100%;
      max-width: 170px;
    }
    .radio-container {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 0.2rem;
    }
    .radio-container label {
      display: flex;
      align-items: center;
      gap: 0.2rem;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .radio-container input[type="radio"] {
      transform: scale(0.9);
      accent-color: #f44786;
      cursor: pointer;
    }
    .shape {
      display: inline-block;
      text-align: center;
      vertical-align: middle;
    }
    .shape.circle {
      font-size: 2em;
      line-height: 1em;
      transform: translateY(-0.1em); 
    }
    .shape.square {
      font-size: 1.7em;
      line-height: 1em;
      transform: translateY(-0.17em); 
    }
    .shape.triangle {
      font-size: 1.2em;
      line-height: 1em;
      transform: translateY(-0.09em); 
    }
    .slider-container {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .slider-container input[type="range"] {
      width: 100%;
      max-width: 80px;
    }
    .slider-container span {
      width: 18px;
      text-align: center;
      font-weight: bold;
      font-size: 0.75rem;
    }
    #start-btn {
      background: #f44786;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      font-size: 0.85rem;
      padding: 0.5rem 1rem;       
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
      max-width: 150px;
      margin: 1rem auto 0;       
    }

    /*************************************************************
     * GAME CONTAINER
     *************************************************************/
    #game-container {
      width: 100%;
      max-width: 600px;
      margin: 1rem auto 1rem;  
      background: #ed1b76;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      padding: 0.8rem;
      display: none;
      position: relative;
    }

    /*************************************************************
     * AI SECTION
     *************************************************************/
    #ai-section {
      text-align: center;
      margin-bottom: 0.8rem;
    }
    #ai-section h2 {
      margin-bottom: 0.4rem;
      font-size: 0.9rem;
      color: #ffffff;
      line-height: 1.2rem;
    }
    #ai-choices {
      display: flex;
      justify-content: space-around;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 0.6rem;
    }
    .ai-choice-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      width: 40%;
      max-width: 130px;
    }
    .ai-choice-btn {
      background: #f44786;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 0.8rem;
      padding: 0.4rem;
      min-width: 50px;
      cursor: default;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 80px;
      height: 50px;
      transition: background 0.3s, color 0.3s, border 0.3s;
    }
    .ai-choice-btn img {
      width: 35px;
      height: 35px;
    }
    .ai-choice-btn.selected {
      background: #ffffff;
      color: #ed1b76;
      border: 2px solid #f44786;
    }

    /*************************************************************
     * SCOREBOARD
     *************************************************************/
    #scoreboard {
      text-align: center;
      margin: 0.6rem auto;
      font-size: 0.85rem;
      display: flex;
      justify-content: center;
      gap: 0.8rem;
      flex-wrap: wrap;
    }
    #scoreboard div {
      background: #249f9c;
      color: #ffffff;
      padding: 0.4rem 0.5rem;
      border-radius: 4px;
      width: 35%;
      min-width: 70px;
      text-align: center;
      font-size: 0.85rem;
    }

    /*************************************************************
     * TIMER & STATUS
     *************************************************************/
    #timer-display {
      text-align: center;
      margin: 0.4rem auto;
      font-size: 0.78rem;
      background: #249f9c;
      color: #ffffff;
      padding: 0.3rem 0.4rem;
      border-radius: 4px;
      max-width: 130px;
    }
    #status-message {
      text-align: center;
      font-weight: bold;
      margin-bottom: 0.6rem;
      min-height: 1.2em;
      color: #ffffff;
      font-size: 0.85rem;
    }

    /*************************************************************
     * RESULT SECTION
     *************************************************************/
    #result-section {
      text-align: center;
      margin-top: 0.6rem;
      display: none;
    }
    #result-message {
      font-weight: bold;
      margin-bottom: 0.4rem;
      color: #ffffff;
      font-size: 0.85rem;
      min-height: 1.2rem;
    }
    #next-round-btn,
    #roulette-btn {
      background: #f44786;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 0.8rem;
      padding: 0.4rem 0.6rem;
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
      max-width: 150px;
      margin: 0.2rem auto 0;
      display: none;
    }

    /*************************************************************
     * CHANCE DISPLAY
     *************************************************************/
    #chance-display {
      display: none;  
      text-align: center;
      margin: 0.5rem auto;
      font-size: 0.8rem; 
      background: rgba(255,255,255,0.2);
      border: 1px solid #ffffff;
      border-radius: 4px;
      padding: 0.5rem 0.8rem;
      max-width: 240px;
      line-height: 1.3;
      white-space: pre-line;
    }

    /*************************************************************
     * PLAYER SECTION
     *************************************************************/
    #user-section {
      text-align: center;
      margin-top: 0.6rem;
    }
    #user-section h2 {
      margin-bottom: 0.4rem;
      font-size: 0.9rem;
      color: #ffffff;
      line-height: 1.2rem;
    }
    #user-choices {
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      gap: 0.6rem;
      flex-wrap: wrap;
      margin-bottom: 0.6rem;
    }
    .user-choice-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      width: 40%;
      max-width: 130px;
    }
    .choice-btn {
      background: #f44786;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 0.8rem;
      padding: 0.4rem;
      min-width: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s, color 0.3s, border 0.3s;
      width: 100%;
      max-width: 80px;
      height: 50px;
    }
    .choice-btn img {
      width: 35px;
      height: 35px;
    }
    .choice-btn.selected {
      background: #ffffff;
      color: #ed1b76;
      border: 2px solid #f44786;
    }

    /*************************************************************
     * WINNER HIGHLIGHTING
     *************************************************************/
    .winner {
      border: 2px solid #ffff00;
      box-shadow: 0 0 5px #ffff00;
    }

    /*************************************************************
     * MEDIA QUERIES
     *************************************************************/
    @media (max-width: 480px) {
      #start-menu, #game-container {
        max-width: 95%;
      }
      #start-menu h1 {
        font-size: 1rem;
      }
      #start-menu p,
      #start-menu label {
        font-size: 0.8rem;
      }
      #sound-btn, #start-btn, #next-round-btn, #roulette-btn {
        font-size: 0.75rem;
        padding: 0.3rem 0.6rem;
      }
      .settings-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        column-gap: 0.5rem;
        row-gap: 0.5rem;
      }
      .setting-item {
        width: auto;
        max-width: 100%;
        justify-items: center;
      }
      .ai-choice-btn, .choice-btn {
        max-width: 70px;
        height: 45px;
      }
      .ai-choice-btn img, .choice-btn img {
        width: 30px;
        height: 30px;
      }
      #scoreboard div {
        width: 40%;
        min-width: 60px;
        font-size: 0.75rem;
      }
      #timer-display {
        font-size: 0.7rem;
        max-width: 100px;
      }
      #roulette-visual {
        max-width: 250px;
      }
      #chance-display {
        font-size: 0.75rem;
        max-width: 220px;
        padding: 0.5rem;
      }

      /* Center the gun-sim on mobile */
      #roulette-visual {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #gun-sim {
        width: 80%; /* Adjusted for mobile */
      }
    }

    @media (max-width: 360px) {
      #start-menu h1 {
        font-size: 0.9rem;
      }
      #scoreboard div {
        width: 45%;
        min-width: 50px;
        font-size: 0.7rem;
      }
      .ai-choice-btn, .choice-btn {
        max-width: 60px;
        height: 40px;
      }
      .ai-choice-btn img, .choice-btn img {
        width: 25px;
        height: 25px;
      }
      #roulette-visual h3 {
        font-size: 0.75rem;
      }
      #roulette-spin, #roulette-outcome {
        font-size: 0.7rem;
      }
      #result-message {
        font-size: 0.7rem;
      }

      /* Further adjust the gun-sim for very small screens */
      #gun-sim {
        width: 90%; /* Further adjusted for smaller mobile screens */
      }
    }

    /*************************************************************
     * 2) GUN SIMULATOR (CHAMBER) STYLES
     *    We wrap it inside #gun-sim so it won't override <body>.
     *************************************************************/
    /*************************************************************
 * 2) GUN SIMULATOR (CHAMBER) STYLES
 *    Adjusted for smaller visualization and centered positioning.
 *************************************************************/
#gun-sim {
  width: 50%; /* Reduced from 100% to 50% */
  height: 125px; /* Reduced from 250px to 125px */
  background: #f44786;
  position: relative;
  overflow: hidden;
  margin: 0.5rem auto; /* Center horizontally with auto margins */
  border: 1px dashed #f44786; /* Adjusted border thickness */
  border-radius: 8px;
  /* Keep it hidden until we actually show the spinning chamber */
  display: none;
}

/* Gun barrel visual */
#gun-sim:before {
  content: '';
  display: block;
  width: 25px; /* Reduced from 50px to 25px */
  height: 25px; /* Reduced from 50px to 25px */
  position: absolute;
  border-radius: 50%;
  top: calc(50% - 57.5px); /* Adjusted for new container height */
  left: calc(50% - 25px); /* Adjusted for new width */
  box-shadow: rgba(0, 0, 0, 0.3) 0 2.5px 15px, inset black 0 5px 7.5px, inset rgba(0, 0, 0, 0.3) 0 0 25px;
  border: 12.5px solid #222; /* Reduced border thickness */
  z-index: 10;
}

/* Gun barrel shadow */
#gun-sim:after {
  content: '';
  display: block;
  width: 25px; /* Reduced from 50px to 25px */
  height: 125px; /* Reduced from 250px to 125px */
  position: absolute;
  border-radius: 15px;
  top: calc(50% - 20px); /* Adjusted for new container height */
  left: calc(50% - 12.5px); /* Adjusted for new width */
  background: #222;
  z-index: 5;
  box-shadow: rgba(0, 0, 0, 0.3) 0 2.5px 15px, #210 12.5px 50px 0, #210 0px 50px 0, #210 -12.5px 50px 0;
}

/* Rotating chamber container */
.chamber-container {
  width: 100px; /* Reduced from 200px to 100px */
  height: 100px; /* Reduced from 200px to 100px */
  margin: 0 auto; /* Center horizontally */
  position: absolute;
  border-radius: 100%;
  top: calc(50% + 4px); /* Center vertically */
  left: 50%; /* Center horizontally */
  transform: translate(-50%, -50%) rotate(0deg); /* Center and initial rotation */
  background: radial-gradient(circle, #444 30%, #222 80%);
  z-index: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: transform 0.5s ease-in-out;
}

/* Chamber holes */
.chamber-hole {
  width: 20px; /* Reduced from 40px to 20px */
  height: 20px; /* Reduced from 40px to 20px */
  background: black;
  border-radius: 50%;
  position: absolute;
}


.hole-1 { top: 5px; left: calc(50% - 10px); }
.hole-2 { top: 22.5px; left: 70.5px; }
.hole-3 { bottom: 22.5px; left: 70.5px; }
.hole-4 { bottom: 5px; left: calc(50% - 10px); }
.hole-5 { bottom: 22.5px; right: 70.5px; }
.hole-6 { top: 22.5px; right: 70.5px; }

/* Spin animation */
@keyframes spin {
  from { transform: translate(-50%, -50%) rotate(0deg); }
  to   { transform: translate(-50%, -50%) rotate(360deg); }
}
.spin {
  animation: spin 0.5s ease-in-out;
}

/* Added Styles for Gun Simulator Background Changes */
#gun-sim.safe {
  background-color: #006400; /* Dark Green */
  transition: background-color 0.5s ease;
}

#gun-sim.shot {
  background-color: #8B0000; /* Blood Red */
  transition: background-color 0.5s ease;
}

/* Removed centering for "Russian Roulette!" heading since it's no longer needed */

  </style>
</head>
<body>

  <!-- START MENU -->
  <div id="start-menu">
    <h1>
      <span class="shape circle">●</span>
      <span class="shape square">■</span>
      <span class="shape triangle">▲</span>
      : The Rock Paper Scissors Roulette
    </h1>

    <!-- Sound Toggle Button -->
    <button id="sound-btn" data-sound="off">Music: OFF</button>

    <p><strong>Warning:</strong><br>
      If no decision is made within the time limit, it is considered a disqualification and AI wins the round.
    </p>

    <!-- Settings Container -->
    <div class="settings-container">
      <div class="setting-item">
        <label>Roulette Mode:</label>
        <div class="radio-container">
          <label>
            <input type="radio" name="roulette-mode" value="reset" checked>
            Reset
          </label>
          <label>
            <input type="radio" name="roulette-mode" value="no-reset">
            No Reset
          </label>
        </div>
      </div>

      <div class="setting-item">
        <label for="num-bullets">Bullets:</label>
        <div class="slider-container">
          <input type="range" id="num-bullets" value="1" min="1" max="6" step="1">
          <span id="bullet-count">1</span>
        </div>
      </div>
    </div>

    <button id="start-btn">Start Game</button>
  </div>

  <!-- GAME CONTAINER -->
  <div id="game-container">

    <!-- AI SECTION -->
    <div id="ai-section">
      <h2>AI's Hands</h2>
      <div id="ai-choices">
        <!-- Left column -->
        <div class="ai-choice-column">
          <button class="ai-choice-btn" data-hand="Rock" data-side="left">
            <img src="./assets/icons/rock.png" alt="Rock">
          </button>
          <button class="ai-choice-btn" data-hand="Paper" data-side="left">
            <img src="./assets/icons/paper.png" alt="Paper">
          </button>
          <button class="ai-choice-btn" data-hand="Scissors" data-side="left">
            <img src="./assets/icons/scissors.png" alt="Scissors">
          </button>
        </div>
        <!-- Right column -->
        <div class="ai-choice-column">
          <button class="ai-choice-btn" data-hand="Rock" data-side="right">
            <img src="./assets/icons/rock.png" alt="Rock">
          </button>
          <button class="ai-choice-btn" data-hand="Paper" data-side="right">
            <img src="./assets/icons/paper.png" alt="Paper">
          </button>
          <button class="ai-choice-btn" data-hand="Scissors" data-side="right">
            <img src="./assets/icons/scissors.png" alt="Scissors">
          </button>
        </div>
      </div>
    </div>

    <!-- SCOREBOARD -->
    <div id="scoreboard">
      <div>Player: <span id="player-score">0</span></div>
      <div>AI: <span id="ai-score">0</span></div>
    </div>

    <!-- TIMER & STATUS -->
    <div id="timer-display">Timer: 5s</div>
    <div id="status-message"></div>

    <!-- RESULT SECTION -->
    <div id="result-section">
      <p id="result-message"></p>
      <!-- CHANCE DISPLAY -->
      <div id="chance-display"></div>
      
      <!-- ROULETTE BUTTON & NEXT ROUND -->
      <button id="roulette-btn">Roulette</button>
      <button id="next-round-btn">Next Round</button>
    </div>

    <!-- RUSSIAN ROULETTE VISUAL -->
    <div id="roulette-visual">
      <!-- Removed all textual labels to keep only the visualization -->
      <!--
        2) GUN SIMULATOR CHAMBER:
           Here is the integrated "Gun Simulator" snippet 
           (wrapped in #gun-sim so it doesn't override <body>).
      -->
      <div id="gun-sim">
        <div class="chamber-container" id="chamber-container">
          <div class="chamber-hole hole-1"></div>
          <div class="chamber-hole hole-2"></div>
          <div class="chamber-hole hole-3"></div>
          <div class="chamber-hole hole-4"></div>
          <div class="chamber-hole hole-5"></div>
          <div class="chamber-hole hole-6"></div>
        </div>
      </div>
    </div>

    <!-- PLAYER SECTION -->
    <div id="user-section">
      <h2>Player's Hands</h2>
      <div id="user-choices">
        <div class="user-choice-column" id="user-left-column"></div>
        <div class="user-choice-column" id="user-right-column"></div>
      </div>
    </div>

  </div>

  <!-- Audio Elements -->
  <audio id="bg-music" src="./assets/sounds/scary.mp3" preload="auto" loop></audio>
  <audio id="intro-music" src="./assets/sounds/intro.mp3" preload="auto"></audio>
  <audio id="reload-music" src="./assets/sounds/reload.mp3" preload="auto"></audio>
  <audio id="fire-sound" src="./assets/sounds/fire.wav" preload="auto"></audio>
  <audio id="empty-sound" src="./assets/sounds/empty.wav" preload="auto"></audio>
  <audio id="green-sound" src="./assets/sounds/green.mp3" preload="auto"></audio>

  <script>
    /****************************************************
     * SOUND LOGIC
     ****************************************************/
    const backgroundMusic = document.getElementById('bg-music');
    const introMusic      = document.getElementById('intro-music');
    const reloadMusic     = document.getElementById('reload-music');
    const fireSound       = document.getElementById('fire-sound');
    const emptySound      = document.getElementById('empty-sound');
    const greenSound      = document.getElementById('green-sound');

    let isSoundOn = false;

    const soundBtn          = document.getElementById('sound-btn');
    const numBulletsSlider  = document.getElementById('num-bullets');
    const bulletCountDisplay= document.getElementById('bullet-count');

    function stopAllAudio() {
      backgroundMusic.pause();
      backgroundMusic.currentTime = 0;
      introMusic.pause();
      introMusic.currentTime = 0;
      reloadMusic.pause();
      reloadMusic.currentTime = 0;
      fireSound.pause();
      fireSound.currentTime = 0;
      emptySound.pause();
      emptySound.currentTime = 0;
      greenSound.pause();
      greenSound.currentTime = 0;
    }

    numBulletsSlider.addEventListener('input', () => {
      bulletCountDisplay.textContent = numBulletsSlider.value;
      updateChanceDisplay();
    });

    function updateSoundButtonUI() {
      if (isSoundOn) {
        soundBtn.textContent = "Music: ON";
        soundBtn.setAttribute('data-sound', 'on');
      } else {
        soundBtn.textContent = "Music: OFF";
        soundBtn.setAttribute('data-sound', 'off');
      }
    }

    soundBtn.addEventListener('click', () => {
      isSoundOn = !isSoundOn;
      updateSoundButtonUI();
      if (isSoundOn) {
        backgroundMusic.currentTime = 0;
        backgroundMusic.play().catch(err => {
          console.warn("Background music playback failed:", err);
        });
      } else {
        stopAllAudio();
      }
    });

    /****************************************************
     * STATE / ELEMENTS
     ****************************************************/
    const startMenu         = document.getElementById('start-menu');
    const startBtn          = document.getElementById('start-btn');
    const gameContainer     = document.getElementById('game-container');
    const rouletteModeRadios= document.querySelectorAll('input[name="roulette-mode"]');
    const aiChoiceButtons   = document.querySelectorAll('.ai-choice-btn');

    const RPS = [
      { name: 'Rock',     img: './assets/icons/rock.png' },
      { name: 'Paper',    img: './assets/icons/paper.png' },
      { name: 'Scissors', img: './assets/icons/scissors.png' },
    ];

    const userLeftCol       = document.getElementById('user-left-column');
    const userRightCol      = document.getElementById('user-right-column');

    // Score & Timer
    const playerScoreEl     = document.getElementById('player-score');
    const aiScoreEl         = document.getElementById('ai-score');
    let playerScore = 0;
    let aiScore     = 0;

    const timerDisplay      = document.getElementById('timer-display');
    const statusMessage     = document.getElementById('status-message');
    const resultSection     = document.getElementById('result-section');
    const resultMessage     = document.getElementById('result-message');
    const nextRoundBtn      = document.getElementById('next-round-btn');

    // Chance display
    const chanceDisplay     = document.getElementById('chance-display');

    // Russian Roulette
    const rouletteVisual    = document.getElementById('roulette-visual');
    // Removed references to roulette-spin and roulette-outcome as their elements are deleted
    const rouletteBtn       = document.getElementById('roulette-btn');

    // Gun simulator references
    const gunSimContainer   = document.getElementById('gun-sim');
    const chamberContainer  = document.getElementById('chamber-container');

    // Selections
    let playerLeftHand       = null;
    let playerRightHand      = null;
    let aiLeftHand           = null;
    let aiRightHand          = null;

    // Timers & phases
    let intervalId  = null;
    let timeLeft    = 5;
    let phase       = 1;

    /****************************************************
     * NO-RESET LOGIC
     ****************************************************/
    let rouletteMode       = 'reset';
    let bulletsInChamber   = 1;
    let totalShotsLeft     = 6;  // starts at 6, will shrink if we get a "click"
    let gameOver           = false;
    let rouletteTarget     = null;

    function getSelectedRouletteMode() {
      let selected = 'reset';
      rouletteModeRadios.forEach(radio => {
        if (radio.checked) {
          selected = radio.value;
        }
      });
      return selected;
    }

    /****************************************************
     * START BUTTON
     ****************************************************/
    startBtn.addEventListener('click', () => {
      stopAllAudio();
      startMenu.style.display  = 'none';
      gameContainer.style.display = 'block';

      rouletteMode = getSelectedRouletteMode();
      bulletsInChamber = parseInt(numBulletsSlider.value, 10) || 1;
      bulletsInChamber = Math.min(Math.max(bulletsInChamber, 1), 6);

      playerScore = 0;
      aiScore     = 0;
      playerScoreEl.textContent = playerScore;
      aiScoreEl.textContent     = aiScore;
      gameOver = false;
      totalShotsLeft = 6;

      updateChanceDisplay(); 
      startRound();
    });

    /****************************************************
     * NEXT ROUND & ROULETTE BUTTON
     ****************************************************/
    nextRoundBtn.addEventListener('click', () => {
      if (gameOver) {
        restartGame();
      } else {
        startRound();
      }
    });

    rouletteBtn.addEventListener('click', () => {
      rouletteBtn.style.display = 'none';
      chanceDisplay.style.display = 'none';

      if (!rouletteTarget) return; 
      performRussianRoulette(rouletteTarget);
    });

    /****************************************************
     * ROUND LOGIC
     ****************************************************/
    function startRound() {
      stopAllAudio();
      nextRoundBtn.style.display = 'none';
      rouletteBtn.style.display   = 'none';
      chanceDisplay.style.display = 'none'; 

      document.querySelectorAll('.winner').forEach(btn => btn.classList.remove('winner'));

      rouletteTarget         = null;
      rouletteVisual.style.display = 'none';
      // Removed: rouletteOutcome.textContent  = '';
      // Removed: rouletteSpin.style.display   = 'inline-block';

      // Reset Gun Simulator Background
      gunSimContainer.classList.remove('shot', 'safe');

      phase = 1;
      timeLeft = 5;
      timerDisplay.textContent = `Timer: ${timeLeft}s`;
      statusMessage.textContent = 'Rock, Paper, Scissors (5s)!';
      resultSection.style.display = 'none';
      resultMessage.textContent   = '';

      playerLeftHand  = null;
      playerRightHand = null;
      aiLeftHand      = null;
      aiRightHand     = null;
      aiChoiceButtons.forEach(b => b.classList.remove('selected'));

      buildUserColumns();

      if (isSoundOn) {
        introMusic.playbackRate = 1.0;
        introMusic.play().catch(err => {
          console.warn("Intro music playback failed:", err);
        });
      }

      if (intervalId) clearInterval(intervalId);
      intervalId = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = `Timer: ${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(intervalId);
          introMusic.pause(); 
          if (!playerLeftHand || !playerRightHand) {
            concludeRoundWithAiWin('Time up! AI wins.');
          } else {
            highlightAIHands();
            moveToPhase2();
          }
        }
      }, 1000);
    }

    function moveToPhase2() {
      phase = 2;
      timeLeft = 5;
      timerDisplay.textContent = `Timer: ${timeLeft}s`;
      statusMessage.textContent = 'Minus One (5s)!';

      if (intervalId) clearInterval(intervalId);
      intervalId = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = `Timer: ${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(intervalId);
          introMusic.pause(); 
          concludeRoundWithAiWin('Time up! AI wins.');
        }
      }, 1000);
    }

    function concludeRoundWithAiWin(reason) {
      if (gameOver) return;
      phase = 0;
      statusMessage.textContent = 'Round Over!';
      nextRoundBtn.style.display = 'none';
      rouletteBtn.style.display   = 'block';
      chanceDisplay.style.display = 'block';

      rouletteBtn.textContent = 'Roulette (You)';

      resultSection.style.display = 'block';
      resultMessage.textContent = reason;
      aiScore++;
      aiScoreEl.textContent = aiScore;

      highlightAIHandsFinal();
      rouletteTarget = 'user';
      updateChanceDisplay();
    }

    function concludeRound(playerFinalHand, side) {
      if (intervalId) clearInterval(intervalId);
      phase = 0;
      introMusic.pause();
      introMusic.currentTime = 0;

      const aiFinal = chooseAiBestResponse(aiLeftHand, aiRightHand, playerFinalHand);
      if (aiFinal === aiLeftHand) {
        unhighlightAIHand('right');
      } else {
        unhighlightAIHand('left');
      }

      const winner = getWinner(playerFinalHand, aiFinal);
      resultSection.style.display = 'block';
      nextRoundBtn.style.display  = 'none';
      rouletteBtn.style.display   = 'none';
      chanceDisplay.style.display = 'none';

      if (winner === 'Player') {
        playerScore++;
        playerScoreEl.textContent = playerScore;
        resultMessage.textContent = `You win!`;
        const playerFinalBtn = findUserButton(playerFinalHand, side);
        playerFinalBtn?.classList.add('winner');

        // Player won -> AI must do roulette
        rouletteTarget = 'ai';
        rouletteBtn.style.display = 'block';
        rouletteBtn.textContent = 'Roulette (AI)';
        chanceDisplay.style.display = 'block';
        updateChanceDisplay();
      }
      else if (winner === 'AI') {
        aiScore++;
        aiScoreEl.textContent = aiScore;
        resultMessage.textContent = `AI wins!`;
        const aiFinalSide = (aiFinal === aiLeftHand) ? 'left' : 'right';
        const aiFinalBtn  = findAIButton(aiFinal, aiFinalSide);
        aiFinalBtn?.classList.add('winner');

        // AI won -> player must do roulette
        rouletteTarget = 'user';
        rouletteBtn.style.display = 'block';
        rouletteBtn.textContent = 'Roulette (You)';
        chanceDisplay.style.display = 'block';
        updateChanceDisplay();
      }
      else {
        // It's a draw => no roulette
        resultMessage.textContent = `Draw!`;
        const playerFinalBtn = findUserButton(playerFinalHand, side);
        const aiFinalSide    = (aiFinal === aiLeftHand) ? 'left' : 'right';
        const aiFinalBtn     = findAIButton(aiFinal, aiFinalSide);
        playerFinalBtn?.classList.add('winner');
        aiFinalBtn?.classList.add('winner');
        playGreenSound();
        statusMessage.textContent = 'Round Over!';
        nextRoundBtn.style.display = 'block';
        rouletteTarget = null;
      }
    }

    /****************************************************
     * RUSSIAN ROULETTE
     ****************************************************/
    function performRussianRoulette(target) {
      if (gameOver) return;
      rouletteVisual.style.display = 'block';
      // Removed: rouletteSpin.style.display   = 'inline-block';
      // Removed: rouletteOutcome.textContent  = '';

      // Show the spinning chamber
      gunSimContainer.style.display = 'block'; 

      introMusic.pause();
      introMusic.currentTime = 0;

      reloadMusic.currentTime = 0;
      reloadMusic.play().then(() => {
        reloadMusic.onended = () => {
          reloadMusic.onended = null;
          // Trigger the spin animation on the chamber container
          spinChamber(() => {
            // After spin animation finishes, decide outcome:
            determineRouletteOutcome(target);
          });
        };
      }).catch(err => {
        console.warn("Reload playback failed:", err);
        // If reload sound fails, just proceed
        spinChamber(() => {
          determineRouletteOutcome(target);
        });
      });
    }

    function spinChamber(onFinish) {
      // Add .spin class to animate
      chamberContainer.classList.add('spin');

      chamberContainer.addEventListener('animationend', function handler() {
        chamberContainer.removeEventListener('animationend', handler);
        chamberContainer.classList.remove('spin');
        // Callback to continue logic
        if (typeof onFinish === 'function') onFinish();
      });
    }

    function determineRouletteOutcome(target) {
      let bulletFires = false;

      if (rouletteMode === 'reset') {
        // For reset, random spin each time => bulletsInChamber out of 6
        const rand = Math.floor(Math.random() * 6) + 1;
        bulletFires = (rand <= bulletsInChamber);
      } else {
        // NO-RESET => probability = bulletsInChamber / totalShotsLeft
        const p = bulletsInChamber / totalShotsLeft;
        bulletFires = (Math.random() < p);
      }

      if (bulletFires) {
        // if bullet fired, reduce bullet count
        if (rouletteMode === 'no-reset') {
          bulletsInChamber--;
          totalShotsLeft--;
        }
        fireSound.currentTime = 0;
        fireSound.play().then(() => {
          fireSound.onended = () => {
            fireSound.onended = null;
            updateRouletteOutcome(target, true);
          };
        }).catch(err => {
          console.warn("Fire sound failed:", err);
          updateRouletteOutcome(target, true);
        });

        // Change Gun Simulator Background to Blood Red
        gunSimContainer.classList.add('shot');
        gunSimContainer.classList.remove('safe');

      } else {
        // empty => reduce totalShotsLeft only if no bullet
        if (rouletteMode === 'no-reset') {
          totalShotsLeft--;
        }
        emptySound.currentTime = 0;
        emptySound.play().then(() => {
          emptySound.onended = () => {
            emptySound.onended = null;
            updateRouletteOutcome(target, false);
          };
        }).catch(err => {
          console.warn("Empty sound failed:", err);
          updateRouletteOutcome(target, false);
        });

        // Change Gun Simulator Background to Dark Green
        gunSimContainer.classList.add('safe');
        gunSimContainer.classList.remove('shot');
      }
    }

    function updateRouletteOutcome(target, bulletFires) {
      // Removed: rouletteSpin.style.display = 'none';
      if (bulletFires) {
        // Removed text label, retain only visual
        // rouletteOutcome.textContent = `BANG! ${target.toUpperCase()} is shot.`;
        // Instead, you might want to trigger a visual effect or sound
        gameOver = true;
        statusMessage.textContent = 'GAME OVER!';
        if (target === 'user') {
          resultMessage.textContent = 'BANG! You were shot. AI survived!';
        } else {
          resultMessage.textContent = 'BANG! AI was shot. You survived!';
        }
        nextRoundBtn.style.display = 'block';
        nextRoundBtn.textContent = 'Restart Game';
      } else {
        // Removed the label "CLICK! AI survives."
        // rouletteOutcome.textContent = ''; // Already removed the element
        statusMessage.textContent = 'Round Over!'
        resultMessage.textContent = `CLICK! No bullet was fired!`;

        // Round is over, proceed to next round
        updateChanceDisplay();
        nextRoundBtn.style.display = 'block';
      }
    }

    /****************************************************
     * CHANCE DISPLAY
     ****************************************************/
    function updateChanceDisplay() {
      if (rouletteMode === 'reset') {
        bulletsInChamber = parseInt(numBulletsSlider.value, 10) || 1;
        const pDeath = ((bulletsInChamber / 6) * 100).toFixed(1);
        chanceDisplay.textContent = 
          `Shots Loaded: ${bulletsInChamber} of 6\nChance of Death: ${pDeath}%`;
      } else {
        const p = (bulletsInChamber / totalShotsLeft) * 100;
        chanceDisplay.textContent = 
          `Bullets Loaded: ${bulletsInChamber}\nShots Left: ${totalShotsLeft}\nChance of Death: ${p.toFixed(1)}%`;
      }
    }

    /****************************************************
     * BUILD USER COLUMNS
     ****************************************************/
    function buildUserColumns() {
      userLeftCol.innerHTML  = '';
      userRightCol.innerHTML = '';

      const leftShuffled  = shuffleArray([...RPS]);
      const rightShuffled = shuffleArray([...RPS]);

      leftShuffled.forEach(item => {
        const btn = document.createElement('button');
        btn.classList.add('choice-btn');
        btn.dataset.hand = item.name;
        btn.dataset.side = 'left';
        const img = document.createElement('img');
        img.src = item.img;
        img.alt = item.name;
        btn.appendChild(img);
        btn.addEventListener('click', onUserChoiceClick);
        userLeftCol.appendChild(btn);
      });

      rightShuffled.forEach(item => {
        const btn = document.createElement('button');
        btn.classList.add('choice-btn');
        btn.dataset.hand = item.name;
        btn.dataset.side = 'right';
        const img = document.createElement('img');
        img.src = item.img;
        img.alt = item.name;
        btn.appendChild(img);
        btn.addEventListener('click', onUserChoiceClick);
        userRightCol.appendChild(btn);
      });
    }

    function onUserChoiceClick(e) {
      if (phase !== 1 && phase !== 2) return;
      const side = e.currentTarget.dataset.side;
      const hand = e.currentTarget.dataset.hand;

      if (phase === 1) {
        // Phase 1 logic (pick two hands)
        if (side === 'left') {
          playerLeftHand = (playerLeftHand === hand) ? null : hand;
        } else {
          playerRightHand = (playerRightHand === hand) ? null : hand;
        }
        updateUserSelectedStates();
        if (playerLeftHand && playerRightHand) {
          clearInterval(intervalId);
          highlightAIHands();
          moveToPhase2();
        }
      }
      else if (phase === 2) {
        // Phase 2 logic (REMOVE the unwanted hand)
        if (!playerLeftHand || !playerRightHand) return;

        const finalChoice = (side === 'left') ? playerRightHand : playerLeftHand;
        const finalChoiceSide = (side === 'left') ? 'right' : 'left';

        unhighlightUserHand(side);
        highlightSelectedUserHand(finalChoiceSide);

        concludeRound(finalChoice, finalChoiceSide);
      }
    }

    function highlightSelectedUserHand(side) {
      document.querySelectorAll('#user-choices .choice-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      const chosenHand = (side === 'left') ? playerLeftHand : playerRightHand;
      const selectedBtn = document.querySelector(`#user-${side}-column .choice-btn[data-hand="${chosenHand}"]`);
      if (selectedBtn) {
        selectedBtn.classList.add('selected');
      }
    }

    function updateUserSelectedStates() {
      document.querySelectorAll('#user-choices .choice-btn').forEach(btn => {
        const side = btn.dataset.side;
        const hand = btn.dataset.hand;
        btn.classList.remove('selected');
        if (side === 'left' && hand === playerLeftHand) {
          btn.classList.add('selected');
        }
        if (side === 'right' && hand === playerRightHand) {
          btn.classList.add('selected');
        }
      });
    }

    /****************************************************
     * AI CHOICES
     ****************************************************/
    function highlightAIHands() {
      let firstPick  = randomGestureName();
      let secondPick = randomGestureName();
      aiLeftHand  = firstPick;
      aiRightHand = secondPick;
      aiChoiceButtons.forEach(b => b.classList.remove('selected'));

      findAIButton(firstPick, 'left')?.classList.add('selected');
      findAIButton(secondPick, 'right')?.classList.add('selected');
    }

    function highlightAIHandsFinal() {
      let firstPick  = randomGestureName();
      let secondPick = randomGestureName();
      aiLeftHand  = firstPick;
      aiRightHand = secondPick;
      aiChoiceButtons.forEach(b => b.classList.remove('selected'));

      findAIButton(firstPick, 'left')?.classList.add('selected');
      findAIButton(secondPick, 'right')?.classList.add('selected');
    }

    function chooseAiBestResponse(hand1, hand2, playerFinal) {
      // Simple logic to pick whichever is more likely to win
      if (hand1 !== hand2 && playerLeftHand !== playerRightHand) {
        const allHands = new Set([hand1, hand2, playerFinal]);
        if (allHands.size === 3) {
          return Math.random() < 0.5 ? hand1 : hand2;
        }
      }
      const outcome1 = getWinner(playerFinal, hand1);
      const outcome2 = getWinner(playerFinal, hand2);

      function rank(res) {
        if (res === 'AI')   return 3;
        if (res === 'Draw') return 2;
        return 1;
      }
      const r1 = rank(outcome1);
      const r2 = rank(outcome2);

      if (r1 > r2) return hand1;
      if (r2 > r1) return hand2;
      return hand1;
    }

    /****************************************************
     * DRAW SOUND
     ****************************************************/
    function playGreenSound() {
      greenSound.currentTime = 0;
      greenSound.play().catch(err => {
        console.warn("Green sound playback failed:", err);
      });
    }

    /****************************************************
     * HELPERS
     ****************************************************/
    function findAIButton(hand, side) {
      return document.querySelector(`.ai-choice-btn[data-hand="${hand}"][data-side="${side}"]`);
    }
    function findUserButton(hand, side) {
      return document.querySelector(`#user-${side}-column .choice-btn[data-hand="${hand}"]`);
    }
    function unhighlightUserHand(side) {
      document.querySelectorAll('#user-choices .choice-btn').forEach(btn => {
        if (btn.dataset.side === side) btn.classList.remove('selected');
      });
    }
    function unhighlightAIHand(side) {
      aiChoiceButtons.forEach(btn => {
        if (btn.dataset.side === side) btn.classList.remove('selected');
      });
    }

    function getWinner(user, ai) {
      if (user === ai) return 'Draw';
      if (
        (user === 'Rock' && ai === 'Scissors') ||
        (user === 'Paper' && ai === 'Rock') ||
        (user === 'Scissors' && ai === 'Paper')
      ) {
        return 'Player';
      }
      return 'AI';
    }
    function randomGestureName() {
      const list = ['Rock', 'Paper', 'Scissors'];
      return list[Math.floor(Math.random() * list.length)];
    }
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    /****************************************************
     * RESTART GAME
     ****************************************************/
    function restartGame() {
      playerScore = 0;
      aiScore     = 0;
      playerScoreEl.textContent = playerScore;
      aiScoreEl.textContent     = aiScore;

      isSoundOn = false;
      stopAllAudio();
      updateSoundButtonUI();

      gameContainer.style.display = 'none';
      startMenu.style.display     = 'block';
      gameOver                    = false;

      totalShotsLeft = 6;
      bulletsInChamber = parseInt(numBulletsSlider.value, 10) || 1;

      resultSection.style.display = 'none';
      resultMessage.textContent    = '';
      statusMessage.textContent    = '';
      timerDisplay.textContent     = 'Timer: 5s';
      nextRoundBtn.textContent = 'Next Round';
      nextRoundBtn.style.display   = 'none';
      rouletteBtn.style.display    = 'none';
      chanceDisplay.style.display  = 'none'; 
      // Hide the gun-sim again
      gunSimContainer.style.display = 'none';

      // Reset Gun Simulator Background
      gunSimContainer.classList.remove('shot', 'safe');

      updateChanceDisplay();
    }
  </script>
</body>
</html>
