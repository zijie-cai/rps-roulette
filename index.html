<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rock-Paper-Scissors (Two-Hand Variant + Russian Roulette)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* 
      Squid Game-inspired color palette:
      #ed1b76 (237,27,118)
      #f44786 (244,71,134)
      #ffffff (255,255,255)
      #249f9c (36,159,156)
      #037a76 (3,122,118)
    */

    /* RESET + BASIC LAYOUT */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: Arial, sans-serif;
      background: #037a76; /* Deep teal */
      color: #ffffff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      overflow-x: hidden; /* Hide horizontal scroll if any */
    }

    /*************************************************************
     * START MENU
     *************************************************************/
    #start-menu {
      text-align: center;
      width: 100%;
      max-width: 500px;
      margin: 0.5rem auto;
      background: #ed1b76;
      padding: 0.5rem;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
    }
    #start-menu h1 {
      margin-bottom: 0.3rem;
      font-size: 1.3rem;
      color: #ffffff;
      line-height: 1.3rem;
    }
    #start-menu p {
      margin: 0.4rem 0;
      line-height: 1.2em;
      color: #ffffff;
      font-size: 0.9rem;
    }
    #start-menu label {
      font-weight: bold;
      color: #ffffff;
      font-size: 0.9rem;
    }
    #start-menu select,
    #start-menu input[type="range"] {
      margin: 0.3rem auto;
      padding: 0.3rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.85rem;
      width: 100%;
      max-width: 150px;
      text-align: center;
      display: block;
    }

    /* Sound Toggle Button Styling */
    #sound-btn {
      background: #f44786; 
      color: #ffffff;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      padding: 0.4rem 0.6rem;
      cursor: pointer;
      margin: 0.5rem auto;
      transition: background 0.3s;
      width: 100%;
      max-width: 200px;
    }

    /* Settings Container */
    .settings-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-around;
      gap: 0.4rem;
      flex-wrap: wrap;
      margin: 0 auto 0.5rem;
      width: 100%;
      max-width: 400px;
    }
    .setting-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      width: 100%;
      max-width: 150px;
    }
    .slider-container {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .slider-container input[type="range"] {
      width: 100%;
      max-width: 100px;
    }
    .slider-container span {
      width: 22px; 
      text-align: center;
      font-weight: bold;
      font-size: 0.8rem;
    }

    /* Start Button */
    #start-btn {
      background: #f44786;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      padding: 0.5rem 0.8rem;
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
      max-width: 200px;
      margin: 0.3rem auto;
    }

    /*************************************************************
     * GAME CONTAINER
     *************************************************************/
    #game-container {
      width: 100%;
      max-width: 600px;
      margin: 0.5rem auto 1rem;
      background: #ed1b76;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      padding: 0.5rem;
      display: none; /* Hidden until game starts */
      position: relative;
    }

    /*************************************************************
     * AI SECTION
     *************************************************************/
    #ai-section {
      text-align: center;
      margin-bottom: 0.5rem;
    }
    #ai-section h2 {
      margin-bottom: 0.3rem;
      font-size: 1rem;
      color: #ffffff;
      line-height: 1rem;
    }
    #ai-choices {
      display: flex;
      justify-content: space-around;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .ai-choice-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      width: 40%;
      max-width: 130px;
    }
    .ai-choice-btn {
      background: #f44786;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 0.8rem;
      padding: 0.3rem;
      min-width: 40px;
      /* no hover needed for AI buttons on mobile */
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s, color 0.3s, border 0.3s;
      width: 100%;
      max-width: 70px;
      height: 40px;
      cursor: default; /* AI buttons not clickable by user */
      pointer-events: none;
    }
    .ai-choice-btn img {
      width: 20px;
      height: 20px;
    }
    .ai-choice-btn.selected {
      background: #ffffff; /* White highlight */
      color: #ed1b76;
      border: 2px solid #f44786;
    }

    /*************************************************************
     * SCOREBOARD
     *************************************************************/
    #scoreboard {
      text-align: center;
      margin: 0.3rem auto;
      font-size: 0.8rem;
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    #scoreboard div {
      background: #249f9c; 
      color: #ffffff;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      width: 35%;
      min-width: 70px;
      text-align: center;
      font-size: 0.8rem;
    }

    /* TIMER & STATUS */
    #timer-display {
      text-align: center;
      margin: 0.3rem auto;
      font-size: 0.7rem;
      background: #249f9c;
      color: #ffffff;
      padding: 0.2rem;
      border-radius: 4px;
      max-width: 130px;
    }
    #status-message {
      text-align: center;
      font-weight: bold;
      margin-bottom: 0.5rem;
      min-height: 1.4em;
      color: #ffffff;
      font-size: 0.75rem;
    }

    /*************************************************************
     * RESULT SECTION
     *************************************************************/
    #result-section {
      text-align: center;
      margin-top: 0.5rem;
      display: none; /* Shown after reveal */
    }
    #result-message {
      font-weight: bold;
      margin-bottom: 0.4rem;
      color: #ffffff; 
      font-size: 0.85rem;
      min-height: 1.2rem;
    }
    /* Next Round button */
    #next-round-btn {
      display: none;
      background: #f44786;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 0.8rem;
      padding: 0.3rem 0.6rem;
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
      max-width: 150px;
      margin: 0.2rem auto 0;
    }

    /*************************************************************
     * RUSSIAN ROULETTE VISUAL
     *************************************************************/
    #roulette-visual {
      text-align: center;
      display: none;
      margin: 0.5rem auto;
      font-size: 0.75rem;
      border: 2px dashed #f44786;
      padding: 0.5rem;
      border-radius: 8px;
      background: #ffffff;
      width: 100%;
      max-width: 300px;
      color: #ed1b76;
    }
    #roulette-visual h3 {
      margin-bottom: 0.4rem;
      color: #ed1b76;
      font-size: 0.85rem;
    }
    #roulette-spin {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
    }
    #roulette-outcome {
      margin-top: 0.4rem;
      font-weight: bold;
      font-size: 0.85rem;
    }
    .spin-animation {
      display: inline-block;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

    /*************************************************************
     * PLAYER SECTION
     *************************************************************/
    #user-section {
      text-align: center;
      margin-top: 0.5rem;
    }
    #user-section h2 {
      margin-bottom: 0.3rem;
      font-size: 1rem;
      color: #ffffff;
      line-height: 1rem;
    }
    #user-choices {
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
    }
    .user-choice-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      width: 40%;
      max-width: 130px;
    }
    .choice-btn {
      background: #f44786;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 0.8rem;
      padding: 0.3rem;
      min-width: 40px;
      cursor: pointer; /* Tappable on mobile */
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s, color 0.3s, border 0.3s;
      width: 100%;
      max-width: 70px;
      height: 40px;
    }
    .choice-btn.selected {
      background: #ffffff; 
      color: #ed1b76;
      border: 2px solid #f44786;
    }
    .choice-btn img {
      width: 20px;
      height: 20px;
    }

    /*************************************************************
     * WINNER HIGHLIGHTING
     *************************************************************/
    .winner {
      border: 2px solid #ffff00;
      box-shadow: 0 0 5px #ffff00;
    }

    /*************************************************************
     * MEDIA QUERIES (for smaller screens)
     *************************************************************/
    @media (max-width: 480px) {
      #start-menu, #game-container {
        max-width: 95%;
      }
      #start-menu h1 {
        font-size: 1.1rem;
      }
      #start-menu p, #start-menu label {
        font-size: 0.8rem;
      }
      #sound-btn, #start-btn, #next-round-btn {
        font-size: 0.8rem;
        padding: 0.4rem 0.6rem;
      }
      #ai-section h2, #user-section h2 {
        font-size: 0.9rem;
      }
      .ai-choice-btn, .choice-btn {
        max-width: 60px;
        height: 36px;
        font-size: 0.75rem;
      }
      .ai-choice-btn img, .choice-btn img {
        width: 18px;
        height: 18px;
      }
      #scoreboard div {
        width: 40%;
        min-width: 60px;
        font-size: 0.75rem;
      }
      #timer-display {
        font-size: 0.65rem;
        max-width: 100px;
      }
      #roulette-visual {
        max-width: 250px;
      }
    }

    @media (max-width: 360px) {
      #start-menu h1 {
        font-size: 1rem;
      }
      #scoreboard div {
        width: 45%;
        min-width: 50px;
      }
      .ai-choice-btn, .choice-btn {
        max-width: 50px;
        height: 32px;
        font-size: 0.7rem;
      }
      .ai-choice-btn img, .choice-btn img {
        width: 16px;
        height: 16px;
      }
      #roulette-visual h3 {
        font-size: 0.75rem;
      }
      #roulette-spin, #roulette-outcome {
        font-size: 0.75rem;
      }
      #result-message {
        font-size: 0.75rem;
      }
    }

  </style>
</head>
<body>

  <!-- START MENU -->
  <div id="start-menu">
    <h1>Rock-Paper-Scissors: Two-Hand</h1>

    <!-- Sound Toggle Button -->
    <button id="sound-btn" data-sound="off">Sound: OFF</button>

    <p><strong>New Rule:</strong><br>
      If you fail to pick a hand within 5 seconds, AI wins that round.
    </p>

    <!-- Settings Container -->
    <div class="settings-container">
      <!-- Russian Roulette Mode Selection -->
      <div class="setting-item">
        <label for="mode-select">Roulette Mode:</label>
        <select id="mode-select">
          <option value="reset">Reset each round</option>
          <option value="no-reset">No reset</option>
        </select>
      </div>

      <!-- Number of Bullets Slider -->
      <div class="setting-item">
        <label for="num-bullets">Bullets:</label>
        <div class="slider-container">
          <input type="range" id="num-bullets" value="1" min="1" max="6" step="1">
          <span id="bullet-count">1</span>
        </div>
      </div>
    </div>

    <button id="start-btn">Start Game</button>
  </div>

  <!-- GAME CONTAINER -->
  <div id="game-container">

    <!-- AI SECTION -->
    <div id="ai-section">
      <h2>AI's Stage</h2>
      <div id="ai-choices">
        <!-- Left column -->
        <div class="ai-choice-column">
          <button class="ai-choice-btn" data-hand="Rock" data-side="left">
            <img src="./assets/icons/rock.png" alt="Rock">
          </button>
          <button class="ai-choice-btn" data-hand="Paper" data-side="left">
            <img src="./assets/icons/paper.png" alt="Paper">
          </button>
          <button class="ai-choice-btn" data-hand="Scissors" data-side="left">
            <img src="./assets/icons/scissors.png" alt="Scissors">
          </button>
        </div>
        <!-- Right column -->
        <div class="ai-choice-column">
          <button class="ai-choice-btn" data-hand="Rock" data-side="right">
            <img src="./assets/icons/rock.png" alt="Rock">
          </button>
          <button class="ai-choice-btn" data-hand="Paper" data-side="right">
            <img src="./assets/icons/paper.png" alt="Paper">
          </button>
          <button class="ai-choice-btn" data-hand="Scissors" data-side="right">
            <img src="./assets/icons/scissors.png" alt="Scissors">
          </button>
        </div>
      </div>
    </div>

    <!-- SCOREBOARD -->
    <div id="scoreboard">
      <div>Player: <span id="player-score">0</span></div>
      <div>AI: <span id="ai-score">0</span></div>
    </div>

    <!-- TIMER & STATUS -->
    <div id="timer-display">Timer: 5s</div>
    <div id="status-message"></div>

    <!-- RESULT SECTION -->
    <div id="result-section">
      <p id="result-message"></p>
      <button id="next-round-btn">Next Round</button>
    </div>

    <!-- RUSSIAN ROULETTE VISUAL -->
    <div id="roulette-visual">
      <h3>Russian Roulette!</h3>
      <p id="roulette-spin">Spinning: <span class="spin-animation">ðŸ”„</span></p>
      <p id="roulette-outcome"></p>
    </div>

    <!-- PLAYER SECTION -->
    <div id="user-section">
      <h2>Player's Stage</h2>
      <div id="user-choices">
        <div class="user-choice-column" id="user-left-column"></div>
        <div class="user-choice-column" id="user-right-column"></div>
      </div>
    </div>

  </div>

  <!-- Audio Elements (preloaded) -->
  <audio id="bg-music" src="./assets/sounds/scary.mp3" preload="auto" loop></audio>
  <audio id="intro-music" src="./assets/sounds/intro.mp3" preload="auto"></audio>
  <audio id="reload-music" src="./assets/sounds/reload.mp3" preload="auto"></audio>
  <audio id="fire-sound" src="./assets/sounds/fire.wav" preload="auto"></audio>
  <audio id="empty-sound" src="./assets/sounds/empty.wav" preload="auto"></audio>
  <audio id="green-sound" src="./assets/sounds/green.mp3" preload="auto"></audio> <!-- For draws -->

  <script>
    /****************************************************
     * SOUND LOGIC
     ****************************************************/
    const backgroundMusic = document.getElementById('bg-music');
    const introMusic      = document.getElementById('intro-music');
    const reloadMusic     = document.getElementById('reload-music');
    const fireSound       = document.getElementById('fire-sound');
    const emptySound      = document.getElementById('empty-sound');
    const greenSound      = document.getElementById('green-sound');

    let isSoundOn = false; // Start OFF by default

    const soundBtn          = document.getElementById('sound-btn');
    const numBulletsSlider  = document.getElementById('num-bullets');
    const bulletCountDisplay= document.getElementById('bullet-count');

    // Helper to forcibly stop all audio mid-play
    function stopAllAudio() {
      backgroundMusic.pause();
      backgroundMusic.currentTime = 0;

      introMusic.pause();
      introMusic.currentTime = 0;

      reloadMusic.pause();
      reloadMusic.currentTime = 0;

      fireSound.pause();
      fireSound.currentTime = 0;

      emptySound.pause();
      emptySound.currentTime = 0;

      greenSound.pause();
      greenSound.currentTime = 0;
    }

    // Update bullet count display when slider changes
    numBulletsSlider.addEventListener('input', () => {
      bulletCountDisplay.textContent = numBulletsSlider.value;
    });

    // Updates the button text (Sound: ON/OFF) to match isSoundOn
    function updateSoundButtonUI() {
      if (isSoundOn) {
        soundBtn.textContent = "Sound: ON";
        soundBtn.setAttribute('data-sound', 'on');
      } else {
        soundBtn.textContent = "Sound: OFF";
        soundBtn.setAttribute('data-sound', 'off');
      }
    }

    // Sound Toggle
    soundBtn.addEventListener('click', () => {
      isSoundOn = !isSoundOn;
      updateSoundButtonUI();
      if (isSoundOn) {
        // Attempt to play background music
        backgroundMusic.currentTime = 0;
        backgroundMusic.play().catch(err => {
          console.warn("Background music playback failed:", err);
        });
      } else {
        // Stop all sounds
        stopAllAudio();
      }
    });

    /****************************************************
     * STATE / ELEMENTS
     ****************************************************/
    const startMenu       = document.getElementById('start-menu');
    const startBtn        = document.getElementById('start-btn');
    const gameContainer   = document.getElementById('game-container');
    const modeSelect      = document.getElementById('mode-select');

    const aiChoiceButtons = document.querySelectorAll('.ai-choice-btn');

    const RPS = [
      { name: 'Rock',     img: './assets/icons/rock.png' },
      { name: 'Paper',    img: './assets/icons/paper.png' },
      { name: 'Scissors', img: './assets/icons/scissors.png' },
    ];

    const userLeftCol   = document.getElementById('user-left-column');
    const userRightCol  = document.getElementById('user-right-column');

    // Score & Timer
    const playerScoreEl = document.getElementById('player-score');
    const aiScoreEl     = document.getElementById('ai-score');
    let playerScore = 0;
    let aiScore = 0;

    const timerDisplay    = document.getElementById('timer-display');
    const statusMessage   = document.getElementById('status-message');
    const resultSection   = document.getElementById('result-section');
    const resultMessage   = document.getElementById('result-message');
    const nextRoundBtn    = document.getElementById('next-round-btn');

    // Russian Roulette elements
    const rouletteVisual  = document.getElementById('roulette-visual');
    const rouletteSpin    = document.getElementById('roulette-spin');
    const rouletteOutcome = document.getElementById('roulette-outcome');

    // Selections
    let playerLeftHand  = null;
    let playerRightHand = null;
    let aiLeftHand      = null;
    let aiRightHand     = null;
    let playerFinalChoiceSide = null;

    // Timers & phases
    let intervalId = null;
    let timeLeft   = 5;
    let phase      = 1;
    // For roulette
    let rouletteMode     = 'reset';
    let bulletsInChamber = 1;
    let chamberPositions = [false, false, false, false, false, false];
    let currentChamberIndex = 0;
    let gameOver = false;

    /****************************************************
     * START BUTTON
     ****************************************************/
    startBtn.addEventListener('click', () => {
      // Stop all audio from the menu or leftover
      stopAllAudio();

      // Hide menu, show game
      startMenu.style.display = 'none';
      gameContainer.style.display = 'block';

      // Read user settings
      rouletteMode = modeSelect.value;
      bulletsInChamber = parseInt(numBulletsSlider.value, 10) || 1;
      if (bulletsInChamber < 1) bulletsInChamber = 1;
      if (bulletsInChamber > 6) bulletsInChamber = 6;

      // Reset scores
      playerScore = 0;
      aiScore = 0;
      playerScoreEl.textContent = playerScore;
      aiScoreEl.textContent = aiScore;
      gameOver = false;

      // Setup chamber
      if (rouletteMode === 'no-reset') {
        setupNoResetChamber(bulletsInChamber);
      } else {
        chamberPositions = [false, false, false, false, false, false];
        currentChamberIndex = 0;
      }

      // Start round
      startRound();
    });

    /****************************************************
     * NEXT ROUND BUTTON
     ****************************************************/
    nextRoundBtn.addEventListener('click', () => {
      if (gameOver) {
        restartGame();
      } else {
        startRound();
      }
    });

    /****************************************************
     * ROUND LOGIC
     ****************************************************/
    function startRound() {
      // Stop any leftover sounds before starting a new round
      stopAllAudio();

      nextRoundBtn.textContent = 'Next Round';
      nextRoundBtn.style.display = 'none';

      // Clear winner highlights
      document.querySelectorAll('.winner').forEach(btn => btn.classList.remove('winner'));

      playerFinalChoiceSide = null;

      rouletteVisual.style.display = 'none';
      rouletteOutcome.textContent = '';
      rouletteSpin.style.display = 'inline-block';

      phase = 1;
      timeLeft = 5;
      timerDisplay.textContent = `Timer: ${timeLeft}s`;
      statusMessage.textContent = 'Pick your hands (5s)!';
      resultSection.style.display = 'none';
      resultMessage.textContent = '';

      // Reset picks
      playerLeftHand  = null;
      playerRightHand = null;
      aiLeftHand      = null;
      aiRightHand     = null;
      aiChoiceButtons.forEach(b => b.classList.remove('selected'));

      // Build user columns
      buildUserColumns();

      // If sound is ON, play intro
      if (isSoundOn) {
        introMusic.playbackRate = 1.0;
        introMusic.play().catch(error => {
          console.warn("Intro music playback failed:", error);
        });
      }

      // Start Phase 1 timer
      if (intervalId) clearInterval(intervalId);
      intervalId = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = `Timer: ${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(intervalId);
          // If user hasn't chosen BOTH left & right => AI wins
          if (!playerLeftHand || !playerRightHand) {
            concludeRoundWithAiWin('Time up! AI wins.');
          } else {
            highlightAIHands();
            moveToPhase2();
          }
        }
      }, 1000);
    }

    function moveToPhase2() {
      phase = 2;
      timeLeft = 5;
      timerDisplay.textContent = `Timer: ${timeLeft}s`;
      statusMessage.textContent = 'Pick one final hand (5s)!';

      if (intervalId) clearInterval(intervalId);
      intervalId = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = `Timer: ${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(intervalId);
          concludeRoundWithAiWin('Time up! AI wins.');
        }
      }, 1000);
    }

    /****************************************************
     * TIMEOUT => AI WINS
     ****************************************************/
    function concludeRoundWithAiWin(reason) {
      if (gameOver) return;
      phase = 0;
      statusMessage.textContent = 'Round Over!';
      nextRoundBtn.style.display = 'none';

      resultSection.style.display = 'block';
      resultMessage.textContent = reason;
      aiScore++;
      aiScoreEl.textContent = aiScore;

      highlightAIHandsFinal();
      // Player suffers Russian Roulette
      performRussianRoulette('user');
    }

    /****************************************************
     * USER FINAL PICK
     ****************************************************/
    function concludeRound(playerFinalHand, side) {
      if (intervalId) clearInterval(intervalId);
      phase = 0;

      // Stop intro music if still playing
      introMusic.pause();
      introMusic.currentTime = 0;

      // AI picks final
      const aiFinal = chooseAiBestResponse(aiLeftHand, aiRightHand, playerFinalHand);
      if (aiFinal === aiLeftHand) {
        unhighlightAIHand('right');
      } else {
        unhighlightAIHand('left');
      }

      const winner = getWinner(playerFinalHand, aiFinal);
      resultSection.style.display = 'block';
      nextRoundBtn.style.display = 'none';

      if (winner === 'Player') {
        playerScore++;
        playerScoreEl.textContent = playerScore;
        resultMessage.textContent = `You win!`;
        const playerFinalBtn = findUserButton(playerFinalHand, side);
        playerFinalBtn?.classList.add('winner');
        // AI suffers Russian Roulette
        performRussianRoulette('ai');
      }
      else if (winner === 'AI') {
        aiScore++;
        aiScoreEl.textContent = aiScore;
        resultMessage.textContent = `AI wins!`;
        const aiFinalSide = (aiFinal === aiLeftHand) ? 'left' : 'right';
        const aiFinalBtn = findAIButton(aiFinal, aiFinalSide);
        aiFinalBtn?.classList.add('winner');
        // Player suffers Russian Roulette
        performRussianRoulette('user');
      }
      else {
        // Draw => play green sound, no roulette
        resultMessage.textContent = `It's a draw!`;
        const playerFinalBtn = findUserButton(playerFinalHand, side);
        const aiFinalSide = (aiFinal === aiLeftHand) ? 'left' : 'right';
        const aiFinalBtn = findAIButton(aiFinal, aiFinalSide);
        playerFinalBtn?.classList.add('winner');
        aiFinalBtn?.classList.add('winner');
        playGreenSound();
        statusMessage.textContent = 'Round Over!';
        nextRoundBtn.style.display = 'block';
      }
    }

    /****************************************************
     * RUSSIAN ROULETTE
     ****************************************************/
    function performRussianRoulette(target) {
      if (gameOver) return;
      rouletteVisual.style.display = 'block';
      rouletteSpin.style.display = 'inline-block';
      rouletteOutcome.textContent = '';

      // Stop intro if still playing
      introMusic.pause();
      introMusic.currentTime = 0;

      if (!isSoundOn) {
        determineRouletteOutcome(target);
        return;
      }

      // 1) Play "reload" fully, then outcome
      reloadMusic.currentTime = 0;
      reloadMusic.play().then(() => {
        reloadMusic.onended = () => {
          reloadMusic.onended = null;
          determineRouletteOutcome(target);
        };
      }).catch(error => {
        console.warn("Reload sound playback failed:", error);
        determineRouletteOutcome(target);
      });
    }

    // Decide if bullet fires => then Fire or Empty
    function determineRouletteOutcome(target) {
      let bulletFires = false;
      if (rouletteMode === 'reset') {
        const rand = Math.floor(Math.random() * 6) + 1;
        bulletFires = (rand <= bulletsInChamber);
      } else {
        bulletFires = chamberPositions[currentChamberIndex];
        currentChamberIndex = (currentChamberIndex + 1) % 6;
      }

      if (!isSoundOn) {
        updateRouletteOutcome(target, bulletFires);
        return;
      }

      if (bulletFires) {
        fireSound.currentTime = 0;
        fireSound.play().then(() => {
          fireSound.onended = () => {
            fireSound.onended = null;
            updateRouletteOutcome(target, true);
          };
        }).catch(err => {
          console.warn("Fire sound failed:", err);
          updateRouletteOutcome(target, true);
        });
      } else {
        emptySound.currentTime = 0;
        emptySound.play().then(() => {
          emptySound.onended = () => {
            emptySound.onended = null;
            updateRouletteOutcome(target, false);
          };
        }).catch(err => {
          console.warn("Empty sound failed:", err);
          updateRouletteOutcome(target, false);
        });
      }
    }

    function updateRouletteOutcome(target, bulletFires) {
      rouletteSpin.style.display = 'none';
      if (bulletFires) {
        rouletteOutcome.textContent = `BANG! ${target.toUpperCase()} is shot.`;
        gameOver = true;
        statusMessage.textContent = 'GAME OVER!';
        if (target === 'user') {
          resultMessage.textContent += ' YOU were shot. AI wins the match!';
        } else {
          resultMessage.textContent += ' AI was shot. YOU win the match!';
        }
      } else {
        rouletteOutcome.textContent = `CLICK! ${target.toUpperCase()} survives.`;
      }

      nextRoundBtn.style.display = 'block';
      if (gameOver) {
        nextRoundBtn.textContent = 'Restart Game';
      } else {
        nextRoundBtn.textContent = 'Next Round';
      }
    }

    function setupNoResetChamber(bulletsCount) {
      chamberPositions = [false, false, false, false, false, false];
      currentChamberIndex = 0;
      let count = Math.min(bulletsCount, 6);
      while (count > 0) {
        const idx = Math.floor(Math.random() * 6);
        if (!chamberPositions[idx]) {
          chamberPositions[idx] = true;
          count--;
        }
      }
    }

    /****************************************************
     * BUILD USER CHOICES
     ****************************************************/
    function buildUserColumns() {
      userLeftCol.innerHTML = '';
      userRightCol.innerHTML = '';

      const leftShuffled  = shuffleArray([...RPS]);
      const rightShuffled = shuffleArray([...RPS]);

      leftShuffled.forEach(item => {
        const btn = document.createElement('button');
        btn.classList.add('choice-btn');
        btn.dataset.hand = item.name;
        btn.dataset.side = 'left';
        const img = document.createElement('img');
        img.src = item.img;
        img.alt = item.name;
        btn.appendChild(img);
        btn.addEventListener('click', onUserChoiceClick);
        userLeftCol.appendChild(btn);
      });

      rightShuffled.forEach(item => {
        const btn = document.createElement('button');
        btn.classList.add('choice-btn');
        btn.dataset.hand = item.name;
        btn.dataset.side = 'right';
        const img = document.createElement('img');
        img.src = item.img;
        img.alt = item.name;
        btn.appendChild(img);
        btn.addEventListener('click', onUserChoiceClick);
        userRightCol.appendChild(btn);
      });
    }

    function onUserChoiceClick(e) {
      if (phase !== 1 && phase !== 2) return;
      const side = e.currentTarget.dataset.side;
      const hand = e.currentTarget.dataset.hand;

      if (phase === 1) {
        // Toggle L/R
        if (side === 'left') {
          playerLeftHand = (playerLeftHand === hand) ? null : hand;
        } else {
          playerRightHand = (playerRightHand === hand) ? null : hand;
        }
        updateUserSelectedStates();
        // If both chosen
        if (playerLeftHand && playerRightHand) {
          clearInterval(intervalId);
          highlightAIHands();
          moveToPhase2();
        }
      }
      else if (phase === 2) {
        if (!playerLeftHand || !playerRightHand) return;
        const finalChoice = (side === 'left') ? playerLeftHand : playerRightHand;
        playerFinalChoiceSide = side;
        if (playerLeftHand === playerRightHand) {
          highlightSelectedUserHand(side);
        } else {
          if (finalChoice === playerLeftHand) {
            unhighlightUserHand('right');
          } else {
            unhighlightUserHand('left');
          }
        }
        concludeRound(finalChoice, side);
      }
    }

    function highlightSelectedUserHand(side) {
      document.querySelectorAll('#user-choices .choice-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      const chosenHand = (side === 'left') ? playerLeftHand : playerRightHand;
      const selectedBtn = document.querySelector(`#user-${side}-column .choice-btn[data-hand="${chosenHand}"]`);
      if (selectedBtn) {
        selectedBtn.classList.add('selected');
      }
    }

    /****************************************************
     * AI CHOICES
     ****************************************************/
    function highlightAIHands() {
      let firstPick = randomGestureName();
      let secondPick = randomGestureName();
      aiLeftHand = firstPick;
      aiRightHand = secondPick;
      aiChoiceButtons.forEach(b => b.classList.remove('selected'));

      findAIButton(firstPick, 'left')?.classList.add('selected');
      findAIButton(secondPick, 'right')?.classList.add('selected');
    }

    function highlightAIHandsFinal() {
      // For user timeout scenario
      let firstPick = randomGestureName();
      let secondPick = randomGestureName();
      aiLeftHand = firstPick;
      aiRightHand = secondPick;
      aiChoiceButtons.forEach(b => b.classList.remove('selected'));

      findAIButton(firstPick, 'left')?.classList.add('selected');
      findAIButton(secondPick, 'right')?.classList.add('selected');
    }

    function chooseAiBestResponse(hand1, hand2, playerFinal) {
      // If both AI & user had 2 distinct => might produce all 3 combos => pick randomly
      if (hand1 !== hand2 && playerLeftHand !== playerRightHand) {
        const allHands = new Set([hand1, hand2, playerFinal]);
        if (allHands.size === 3) {
          return Math.random() < 0.5 ? hand1 : hand2;
        }
      }
      // Evaluate outcome
      const outcome1 = getWinner(playerFinal, hand1);
      const outcome2 = getWinner(playerFinal, hand2);

      function rank(res) {
        if (res === 'AI')   return 3;
        if (res === 'Draw') return 2;
        return 1;
      }
      const r1 = rank(outcome1);
      const r2 = rank(outcome2);

      if (r1 > r2) return hand1;
      if (r2 > r1) return hand2;
      return hand1;
    }

    /****************************************************
     * VISUAL UPDATES
     ****************************************************/
    function updateUserSelectedStates() {
      document.querySelectorAll('#user-choices .choice-btn').forEach(btn => {
        const side = btn.dataset.side;
        const hand = btn.dataset.hand;
        btn.classList.remove('selected');
        if (side === 'left' && hand === playerLeftHand) {
          btn.classList.add('selected');
        }
        if (side === 'right' && hand === playerRightHand) {
          btn.classList.add('selected');
        }
      });
    }

    function unhighlightUserHand(side) {
      document.querySelectorAll('#user-choices .choice-btn').forEach(btn => {
        if (btn.dataset.side === side) {
          btn.classList.remove('selected');
        }
      });
    }

    function unhighlightAIHand(side) {
      aiChoiceButtons.forEach(btn => {
        if (btn.dataset.side === side) {
          btn.classList.remove('selected');
        }
      });
    }

    /****************************************************
     * DRAW SOUND
     ****************************************************/
    function playGreenSound() {
      if (isSoundOn) {
        greenSound.currentTime = 0;
        greenSound.play().catch(error => {
          console.warn("Green sound playback failed:", error);
        });
      }
    }

    /****************************************************
     * HELPERS
     ****************************************************/
    function findAIButton(hand, side) {
      return document.querySelector(`.ai-choice-btn[data-hand="${hand}"][data-side="${side}"]`);
    }
    function findUserButton(hand, side) {
      return document.querySelector(`#user-${side}-column .choice-btn[data-hand="${hand}"]`);
    }

    function getWinner(user, ai) {
      if (user === ai) return 'Draw';
      if (
        (user === 'Rock' && ai === 'Scissors') ||
        (user === 'Paper' && ai === 'Rock') ||
        (user === 'Scissors' && ai === 'Paper')
      ) {
        return 'Player';
      }
      return 'AI';
    }
    function randomGestureName() {
      const list = ['Rock','Paper','Scissors'];
      return list[Math.floor(Math.random() * list.length)];
    }
    function shuffleArray(arr) {
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    /****************************************************
     * RESTART GAME
     ****************************************************/
    function restartGame() {
      playerScore = 0;
      aiScore = 0;
      playerScoreEl.textContent = playerScore;
      aiScoreEl.textContent = aiScore;

      // Force sound OFF upon restart
      isSoundOn = false;
      stopAllAudio();
      updateSoundButtonUI();

      gameContainer.style.display = 'none';
      startMenu.style.display = 'block';
      gameOver = false;

      if (rouletteMode === 'no-reset') {
        setupNoResetChamber(bulletsInChamber);
      } else {
        chamberPositions = [false, false, false, false, false, false];
        currentChamberIndex = 0;
      }

      resultSection.style.display = 'none';
      resultMessage.textContent = '';
      statusMessage.textContent = '';
      timerDisplay.textContent = 'Timer: 5s';
      nextRoundBtn.style.display = 'none';
    }
  </script>
</body>
</html>
